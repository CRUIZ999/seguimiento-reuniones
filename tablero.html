<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seguimiento de tareas y reuniones</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --azul: #2563eb;
      --azul-oscuro: #1e40af;
      --gris-fondo: #f3f4f6;
      --gris-borde: #e5e7eb;
      --texto: #111827;
      --verde: #16a34a;
      --amarillo: #facc15;
      --rojo: #dc2626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--gris-fondo);
      color: var(--texto);
    }

    .page {
      max-width: 1300px;
      margin: 16px auto 32px auto;
      padding: 0 16px;
    }

    header.header-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-text h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    .title-text .subtitle {
      margin: 2px 0 0 0;
      font-size: 12px;
      color: #6b7280;
    }

    #userLabel {
      font-weight: 500;
      color: #111827;
    }

    /* Icono de ayuda */
    #helpIcon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      cursor: pointer;
      background: #f9fafb;
      color: #111827;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.12);
      user-select: none;
    }

    #helpIcon:hover {
      background: #e5e7eb;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    button.btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f3f4f6;
      color: #111827;
      font-weight: 500;
    }

    button.btn-primary {
      background: var(--azul);
      border-color: var(--azul);
      color: #ffffff;
    }

    button.btn-danger {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    button.btn:hover {
      background: #e5e7eb;
    }

    button.btn-primary:hover {
      background: var(--azul-oscuro);
    }

    button.btn-danger:hover {
      background: #fecaca;
    }

    .card-main {
      background: #ffffff;
      border-radius: 18px;
      box-shadow:
        0 12px 25px rgba(15, 23, 42, 0.12),
        0 1px 2px rgba(15, 23, 42, 0.06);
      padding: 14px 14px 10px 14px;
    }

    /* Resumen y filtros */
    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 8px;
    }

    .summary-left span {
      margin-right: 10px;
    }

    .summary-left b {
      color: #111827;
    }

    .summary-right {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #f3f4f6;
      color: #111827;
    }

    .chip:hover {
      background: #e5e7eb;
    }

    .chip.active-chip {
      background: var(--azul);
      border-color: var(--azul);
      color: #ffffff;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .filters-left {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filters-left label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #4b5563;
    }

    .filters-left input[type="text"],
    .filters-left select {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 5px 10px;
      font-size: 13px;
      background: #ffffff;
    }

    .filters-left input[type="text"] {
      min-width: 200px;
    }

    .filters-left .checkbox-inline {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .filters-right {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn-filter {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
    }

    .btn-filter.primary {
      background: var(--azul);
      border-color: var(--azul);
      color: #ffffff;
    }

    .btn-filter.primary:hover {
      background: var(--azul-oscuro);
    }

    .btn-filter.secondary:hover {
      background: #d1d5db;
    }

    /* Tabla */
    .table-wrapper {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid var(--gris-borde);
      overflow: hidden;
      background: #f9fafb;
    }

    .table-scroll {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 520px;
    }

    table {
      border-collapse: collapse;
      width: max(100%, 900px);
      font-size: 12px;
    }

    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      min-width: 140px;
      background: #ffffff;
    }

    th {
      font-weight: 600;
      font-size: 12px;
      color: #374151;
    }

    /* Fijar primeras 5 columnas */
    th.sticky,
    td.sticky {
      position: sticky;
      left: 0;
      z-index: 4;
      background: #ffffff;
    }

    th.sticky:nth-child(1), td.sticky:nth-child(1) { left: 0; }
    th.sticky:nth-child(2), td.sticky:nth-child(2) { left: 140px; }
    th.sticky:nth-child(3), td.sticky:nth-child(3) { left: 280px; }
    th.sticky:nth-child(4), td.sticky:nth-child(4) { left: 420px; }
    th.sticky:nth-child(5), td.sticky:nth-child(5) { left: 560px; }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    tr.hidden-by-filter {
      display: none;
    }

    td[contenteditable="true"] {
      cursor: text;
    }

    td:focus-visible {
      outline: 2px solid var(--azul);
      outline-offset: -2px;
    }

    /* Estado pill */
    .estado-pill {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 4px;
    }

    .estado-P  { background: #fee2e2; color: #b91c1c; }
    .estado-EP { background: #fef3c7; color: #92400e; }
    .estado-T  { background: #dcfce7; color: #166534; }

    .estado-select {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 2px 6px;
      font-size: 11px;
    }

    /* Comentarios triangulito amarillo */
    td[data-has-comment="1"] {
      position: relative;
    }

    td[data-has-comment="1"]::after {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      width: 0;
      height: 0;
      border-top: 10px solid var(--amarillo);
      border-left: 10px solid transparent;
    }

    .footer-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    /* Modal gen√©rico (ayuda y responsables) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal {
      background: #ffffff;
      border-radius: 16px;
      max-width: 720px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px 24px 16px 24px;
      box-shadow:
        0 20px 25px -5px rgba(15, 23, 42, 0.25),
        0 8px 10px -6px rgba(15, 23, 42, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 20px;
      padding: 0 4px;
    }

    .modal-body p {
      margin: 4px 0;
      font-size: 13px;
      line-height: 1.5;
    }

    .modal-body hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 8px 0;
    }

    /* Men√∫ flotante responsables */
    .responsable-menu {
      position: absolute;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
      padding: 6px 0 4px 0;
      min-width: 180px;
      z-index: 998;
      display: none;
    }

    .responsable-menu-item {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
    }

    .responsable-menu-item:hover {
      background: #f3f4f6;
    }

    .responsable-menu-footer {
      border-top: 1px solid #e5e7eb;
      margin-top: 4px;
      padding: 4px 6px;
      display: flex;
      gap: 4px;
    }

    .responsable-menu-footer button {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 3px 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .responsable-menu-footer button:hover {
      background: #eef2ff;
    }

    .responsables-list-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .responsables-list-row input {
      flex: 1;
      padding: 5px 7px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    .responsables-list-row button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .responsables-list-row button:hover {
      background: #fee2e2;
    }

    .responsables-modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .responsables-modal-footer button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .responsables-modal-footer button.primary {
      background: var(--azul);
      color: #ffffff;
      border-color: var(--azul);
    }

    .responsables-modal-footer button.primary:hover {
      background: var(--azul-oscuro);
    }

    @media (max-width: 768px) {
      header.header-main {
        flex-direction: column;
        align-items: flex-start;
      }
      .toolbar {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header-main">
      <div class="title-block">
        <div class="title-text">
          <h1>Seguimiento de tareas y reuniones</h1>
          <div class="subtitle">
            Usuario: <span id="userLabel">Cargando‚Ä¶</span>
          </div>
        </div>
        <div id="helpIcon" title="Doble clic para ver ayuda">?</div>
      </div>

      <div class="toolbar">
        <button id="btnAddRow" class="btn btn-primary">+ Fila</button>
        <button id="btnAddColumn" class="btn">+ Columna</button>
        <button id="btnExport" class="btn">‚¨á Exportar JSON</button>
        <button id="btnImport" class="btn">‚¨Ü Importar JSON</button>
        <button id="btnLogout" class="btn btn-danger">Cerrar sesi√≥n</button>
      </div>
    </header>

    <div class="card-main">
      <!-- Contadores -->
      <div class="summary-row">
        <div class="summary-left">
          <span>Pendientes: <b id="countPendientes">0</b></span>
          <span>En proceso: <b id="countEnProceso">0</b></span>
          <span>Terminados: <b id="countTerminados">0</b></span>
        </div>
        <div class="summary-right">
          <button id="btnSoloHoy" class="chip">Solo hoy</button>
        </div>
      </div>

      <!-- Filtros en una sola fila -->
      <div class="filters-row">
        <div class="filters-left">
          <label>
            Buscar:
            <input id="filtroTexto" type="text" placeholder="Palabra o frase..." />
          </label>

          <label>
            Estado:
            <select id="filtroEstado">
              <option value="todos">Todos</option>
              <option value="P">Pendiente</option>
              <option value="EP">En proceso</option>
              <option value="T">Terminado</option>
            </select>
          </label>

          <label>
            Responsable:
            <select id="filtroResponsable">
              <option value="todos">Todos</option>
            </select>
          </label>

          <label class="checkbox-inline">
            <input type="checkbox" id="chkOcultarTerminados" />
            Ocultar terminados
          </label>
        </div>

        <div class="filters-right">
          <button id="btnAplicarFiltros" class="btn-filter primary">Filtro</button>
          <button id="btnQuitarFiltros" class="btn-filter secondary">Quitar filtro</button>
        </div>
      </div>

      <!-- Tabla -->
      <div class="table-wrapper">
        <div class="table-scroll">
          <table id="tabla">
            <thead>
              <tr id="headerRow"></tr>
            </thead>
            <tbody id="bodyRows"></tbody>
          </table>
        </div>
      </div>

      <div class="footer-note">
        ‚úî Los datos (incluyendo comentarios y lista de responsables) se guardan en este navegador, por usuario.
      </div>
    </div>
  </div>

  <!-- Modal Ayuda -->
  <div id="helpModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Ayuda r√°pida</div>
        <button id="helpModalClose" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p><strong>Columnas base:</strong> <em>tema</em>, <em>sub tema</em>, <em>responsable</em>, <em>estado</em>, <em>fecha de t√©rmino</em>.</p>
        <p><strong>estado</strong> usa: <strong>P</strong> (Pendiente), <strong>EP</strong> (En proceso), <strong>T</strong> (Terminado).</p>

        <p>üëâ En <strong>sub tema</strong> puedes pegar un link de Google Drive; si la celda s√≥lo tiene la URL, con <strong>doble clic</strong> se abre en otra pesta√±a.</p>
        <p>üëâ Clic derecho en cualquier celda (excepto responsable) para agregar comentario (tri√°ngulo amarillo).</p>
        <p>üëâ Clic en una celda de <strong>responsable</strong> para abrir la lista y seleccionar un nombre.</p>
        <p>üëâ Clic derecho en una celda de <strong>responsable</strong> abre el editor de la lista de responsables (agregar / quitar nombres).</p>

        <hr>

        <p><strong>Reuniones:</strong> cada nueva columna de reuni√≥n se crea con la fecha del d√≠a como t√≠tulo (puedes ajustar manualmente el texto).</p>
        <p><strong>Filtros r√°pidos:</strong> puedes filtrar por texto, estado, responsable y ocultar tareas terminadas. El bot√≥n "Solo hoy" filtra por fecha de t√©rmino igual a la fecha actual.</p>

        <hr>

        <p><strong>Datos:</strong> todas las tareas y comentarios se guardan en <em>localStorage</em> por usuario (usando la sesi√≥n de Supabase).</p>
      </div>
    </div>
  </div>

  <!-- Men√∫ flotante de responsables -->
  <div id="responsableMenu" class="responsable-menu">
    <div id="responsableMenuList"></div>
    <div class="responsable-menu-footer">
      <button id="responsableMenuAdd">+ Agregar</button>
      <button id="responsableMenuEdit">Editar lista</button>
    </div>
  </div>

  <!-- Modal editar responsables -->
  <div id="responsablesModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Editar responsables</div>
        <button id="responsablesModalClose" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>Puedes agregar o quitar nombres. Esta lista se guarda en este navegador.</p>
        <div id="responsablesEditList"></div>
        <button id="responsablesAddRow" style="margin-top:6px;">+ Agregar responsable</button>

        <div class="responsables-modal-footer">
          <button id="responsablesCancel">Cancelar</button>
          <button id="responsablesSave" class="primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===========================
    // CONFIGURACI√ìN SUPABASE
    // ===========================
    const SUPABASE_URL = 'https://hrbmstaklleraiacqmky.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyYm1zdGFrbGxlcmFpYWNxbWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTA2OTQsImV4cCI6MjA3ODc4NjY5NH0.tN00tAjMJpJK_8gnerocbOSzHp93N5yc9KohTBpMeZc';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const BASE_COLUMNS = ['tema', 'subTema', 'responsable', 'estado', 'fechaTermino'];
    const BASE_HEADERS = {
      tema: 'tema',
      subTema: 'sub tema',
      responsable: 'responsable',
      estado: 'estado',
      fechaTermino: 'fecha de termino'
    };

    let currentUser = null;
    let storageKey = null;

    const state = {
      responsables: [],
      meetings: [],
      rows: [],
      comments: {},
    };

    const headerRow = document.getElementById('headerRow');
    const bodyRows = document.getElementById('bodyRows');

    const userLabel = document.getElementById('userLabel');

    const btnAddRow = document.getElementById('btnAddRow');
    const btnAddColumn = document.getElementById('btnAddColumn');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const btnLogout = document.getElementById('btnLogout');

    const filtroTexto = document.getElementById('filtroTexto');
    const filtroEstado = document.getElementById('filtroEstado');
    const filtroResponsable = document.getElementById('filtroResponsable');
    const chkOcultarTerminados = document.getElementById('chkOcultarTerminados');
    const btnAplicarFiltros = document.getElementById('btnAplicarFiltros');
    const btnQuitarFiltros = document.getElementById('btnQuitarFiltros');
    const btnSoloHoy = document.getElementById('btnSoloHoy');

    const spanPend = document.getElementById('countPendientes');
    const spanEP = document.getElementById('countEnProceso');
    const spanT = document.getElementById('countTerminados');

    const helpIcon = document.getElementById('helpIcon');
    const helpModalBackdrop = document.getElementById('helpModalBackdrop');
    const helpModalClose = document.getElementById('helpModalClose');

    const responsableMenu = document.getElementById('responsableMenu');
    const responsableMenuList = document.getElementById('responsableMenuList');
    const responsableMenuAdd = document.getElementById('responsableMenuAdd');
    const responsableMenuEdit = document.getElementById('responsableMenuEdit');

    const responsablesModalBackdrop = document.getElementById('responsablesModalBackdrop');
    const responsablesModalClose = document.getElementById('responsablesModalClose');
    const responsablesEditList = document.getElementById('responsablesEditList');
    const responsablesAddRow = document.getElementById('responsablesAddRow');
    const responsablesCancel = document.getElementById('responsablesCancel');
    const responsablesSave = document.getElementById('responsablesSave');

    let filtroSoloHoy = false;

    // ===========================
    // UTILIDADES
    // ===========================
    function todayString() {
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function getCommentKey(rowIndex, colKey) {
      return rowIndex + '|' + colKey;
    }

    function saveState() {
      if (!storageKey) return;
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function loadState() {
      if (!storageKey) return;
      const raw = localStorage.getItem(storageKey);
      if (!raw) {
        state.responsables = [''];
        state.meetings = [];
        state.rows = [];
        state.comments = {};
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        Object.assign(state, parsed);
      } catch (e) {
        console.error('Error leyendo estado guardado', e);
      }
    }

    // ===========================
    // RENDER TABLA
    // ===========================
    function renderHeader() {
      headerRow.innerHTML = '';
      BASE_COLUMNS.forEach((colName, index) => {
        const th = document.createElement('th');
        th.textContent = BASE_HEADERS[colName];
        th.classList.add('sticky');
        headerRow.appendChild(th);
      });

      state.meetings.forEach(dateLabel => {
        const th = document.createElement('th');
        th.textContent = dateLabel;
        headerRow.appendChild(th);
      });
    }

    function renderBody() {
      bodyRows.innerHTML = '';

      state.rows.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.dataset.index = rowIndex;

        // tema
        let td = document.createElement('td');
        td.classList.add('sticky', 'cell-tema');
        td.contentEditable = true;
        td.textContent = row.tema || '';
        td.dataset.row = rowIndex;
        td.dataset.field = 'tema';
        td.addEventListener('input', handleTextEdit);
        tr.appendChild(td);

        // subTema
        td = document.createElement('td');
        td.classList.add('sticky', 'cell-subtema');
        td.contentEditable = true;
        td.textContent = row.subTema || '';
        td.dataset.row = rowIndex;
        td.dataset.field = 'subTema';
        td.addEventListener('input', handleTextEdit);
        tr.appendChild(td);

        // responsable
        td = document.createElement('td');
        td.classList.add('sticky', 'cell-responsable');
        td.dataset.row = rowIndex;
        td.textContent = row.responsable || '';
        tr.appendChild(td);

        // estado
        td = document.createElement('td');
        td.classList.add('sticky', 'cell-estado');
        const sel = document.createElement('select');
        sel.className = 'estado-select';
        [['P','P'], ['EP','EP'], ['T','T']].forEach(([val, label]) => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = label;
          sel.appendChild(opt);
        });
        sel.value = row.estado || 'P';
        sel.dataset.row = rowIndex;
        sel.addEventListener('change', (e) => {
          state.rows[rowIndex].estado = e.target.value;
          saveState();
          renderBody();
          recalcularContadores();
        });
        const pill = document.createElement('span');
        pill.className = 'estado-pill estado-' + (row.estado || 'P');
        pill.textContent = row.estado || 'P';
        td.appendChild(sel);
        td.appendChild(pill);
        tr.appendChild(td);

        // fechaTermino
        td = document.createElement('td');
        td.classList.add('sticky', 'cell-fecha');
        td.contentEditable = true;
        td.textContent = row.fechaTermino || '';
        td.dataset.row = rowIndex;
        td.dataset.field = 'fechaTermino';
        td.addEventListener('input', handleTextEdit);
        tr.appendChild(td);

        // columnas de reuniones
        state.meetings.forEach(dateLabel => {
          td = document.createElement('td');
          const colKey = dateLabel;
          const value = (row.reuniones || {})[colKey] || '';
          td.contentEditable = true;
          td.textContent = value;
          td.dataset.row = rowIndex;
          td.dataset.meeting = colKey;
          td.addEventListener('input', handleMeetingEdit);

          const cKey = getCommentKey(rowIndex, colKey);
          if (state.comments[cKey]) {
            td.dataset.hasComment = '1';
          }

          tr.appendChild(td);
        });

        bodyRows.appendChild(tr);
      });

      aplicarFiltros(); // re-aplicar filtros despu√©s de render
      recalcularContadores();
    }

    function handleTextEdit(e) {
      const rowIndex = Number(e.target.dataset.row);
      const field = e.target.dataset.field;
      if (!Number.isFinite(rowIndex) || !field) return;
      state.rows[rowIndex][field] = e.target.textContent;
      saveState();
    }

    function handleMeetingEdit(e) {
      const rowIndex = Number(e.target.dataset.row);
      const meetingKey = e.target.dataset.meeting;
      if (!Number.isFinite(rowIndex) || !meetingKey) return;
      if (!state.rows[rowIndex].reuniones) {
        state.rows[rowIndex].reuniones = {};
      }
      state.rows[rowIndex].reuniones[meetingKey] = e.target.textContent;
      saveState();
    }

    // ===========================
    // COMENTARIOS (clic derecho)
    // ===========================
    document.getElementById('tabla').addEventListener('contextmenu', (e) => {
      const td = e.target.closest('td');
      if (!td || td.closest('thead')) return;
      // si es responsable: intercepta para abrir modal de responsables
      if (td.classList.contains('cell-responsable')) {
        e.preventDefault();
        openResponsablesModal();
        return;
      }

      e.preventDefault();
      const rowIndex = td.dataset.row;
      if (rowIndex === undefined) return;

      let colKey = td.dataset.field;
      if (td.dataset.meeting) colKey = td.dataset.meeting;
      if (!colKey) colKey = 'base-' + td.cellIndex;

      const key = getCommentKey(rowIndex, colKey);
      const actual = state.comments[key] || '';

      const nuevo = prompt('Comentario para esta celda (deja vac√≠o para borrar):', actual);
      if (nuevo === null) return;

      if (nuevo.trim() === '') {
        delete state.comments[key];
        td.removeAttribute('data-has-comment');
      } else {
        state.comments[key] = nuevo.trim();
        td.dataset.hasComment = '1';
      }
      saveState();
    });

    // ===========================
    // BOTONES PRINCIPALES
    // ===========================
    btnAddRow.addEventListener('click', () => {
      state.rows.push({
        tema: '',
        subTema: '',
        responsable: '',
        estado: 'P',
        fechaTermino: '',
        reuniones: {}
      });
      saveState();
      renderBody();
    });

    btnAddColumn.addEventListener('click', () => {
      const today = todayString();
      const label = prompt('Fecha para la nueva reuni√≥n (dd/mm/aaaa). Deja vac√≠o para usar la fecha de hoy:', today) || today;
      if (state.meetings.includes(label)) {
        alert('Esa fecha ya existe como columna.');
        return;
      }
      state.meetings.push(label);
      state.rows.forEach(row => {
        if (!row.reuniones) row.reuniones = {};
        row.reuniones[label] = row.reuniones[label] || '';
      });
      saveState();
      renderHeader();
      renderBody();
    });

    btnExport.addEventListener('click', () => {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'seguimiento_reuniones.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const imported = JSON.parse(reader.result);
            Object.assign(state, imported);
            saveState();
            renderHeader();
            renderBody();
            rellenarComboResponsables();
          } catch (err) {
            console.error(err);
            alert('No se pudo importar el archivo JSON.');
          }
        };
        reader.readAsText(file);
      });
      input.click();
    });

    btnLogout.addEventListener('click', async () => {
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.warn('Error al cerrar sesi√≥n', e);
      } finally {
        window.location.href = 'index.html';
      }
    });

    // ===========================
    // FILTROS Y CONTADORES
    // ===========================
    function rellenarComboResponsables() {
      if (!filtroResponsable) return;
      const valueActual = filtroResponsable.value || 'todos';
      filtroResponsable.innerHTML = '<option value="todos">Todos</option>';
      (responsablesList || []).forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        filtroResponsable.appendChild(opt);
      });
      const opt = Array.from(filtroResponsable.options).find(o => o.value === valueActual);
      if (opt) opt.selected = true;
    }

    function recalcularContadores() {
      const rows = document.querySelectorAll('#bodyRows tr');
      let cP = 0, cEP = 0, cT = 0;

      rows.forEach(row => {
        const cellEstado = row.querySelector('.cell-estado');
        if (!cellEstado) return;
        const pill = cellEstado.querySelector('.estado-pill');
        const estado = (pill?.textContent || '').trim().toUpperCase();
        if (estado === 'P') cP++;
        else if (estado === 'EP') cEP++;
        else if (estado === 'T') cT++;
      });

      spanPend.textContent = cP;
      spanEP.textContent = cEP;
      spanT.textContent = cT;
    }

    function aplicarFiltros() {
      const texto = (filtroTexto.value || '').toLowerCase().trim();
      const est = filtroEstado.value;
      const resp = filtroResponsable.value;
      const ocultarTerminados = chkOcultarTerminados.checked;

      const hoy = new Date();
      const hoyStr = todayString();

      const rows = document.querySelectorAll('#bodyRows tr');

      rows.forEach(row => {
        let visible = true;

        const cellTema = row.querySelector('.cell-tema');
        const cellSubTema = row.querySelector('.cell-subtema');
        const cellResp = row.querySelector('.cell-responsable');
        const cellEstado = row.querySelector('.cell-estado');
        const cellFecha = row.querySelector('.cell-fecha');

        const txtRow = [
          cellTema?.textContent || '',
          cellSubTema?.textContent || '',
          cellResp?.textContent || ''
        ].join(' ').toLowerCase();

        const pill = cellEstado?.querySelector('.estado-pill');
        const estado = (pill?.textContent || '').trim().toUpperCase();
        const nombreResp = (cellResp?.textContent || '').trim();
        const fechaTexto = (cellFecha?.textContent || '').trim();

        // 1) filtro de texto
        if (texto && !txtRow.includes(texto)) {
          visible = false;
        }

        // 2) filtro de estado
        if (visible && est !== 'todos') {
          if (estado !== est) visible = false;
        }

        // 3) filtro de responsable
        if (visible && resp !== 'todos') {
          if (nombreResp !== resp) visible = false;
        }

        // 4) ocultar terminados
        if (visible && ocultarTerminados && estado === 'T') {
          visible = false;
        }

        // 5) Solo hoy
        if (visible && filtroSoloHoy) {
          if (fechaTexto !== hoyStr) visible = false;
        }

        if (visible) {
          row.classList.remove('hidden-by-filter');
        } else {
          row.classList.add('hidden-by-filter');
        }
      });
    }

    btnAplicarFiltros.addEventListener('click', aplicarFiltros);

    btnQuitarFiltros.addEventListener('click', () => {
      filtroTexto.value = '';
      filtroEstado.value = 'todos';
      filtroResponsable.value = 'todos';
      chkOcultarTerminados.checked = false;
      filtroSoloHoy = false;
      btnSoloHoy.classList.remove('active-chip');
      const rows = document.querySelectorAll('#bodyRows tr');
      rows.forEach(r => r.classList.remove('hidden-by-filter'));
    });

    btnSoloHoy.addEventListener('click', () => {
      filtroSoloHoy = !filtroSoloHoy;
      if (filtroSoloHoy) {
        btnSoloHoy.classList.add('active-chip');
      } else {
        btnSoloHoy.classList.remove('active-chip');
      }
      aplicarFiltros();
    });

    // ===========================
    // AYUDA (MODAL)
    // ===========================
    helpIcon.addEventListener('dblclick', () => {
      helpModalBackdrop.style.display = 'flex';
    });

    helpModalClose.addEventListener('click', () => {
      helpModalBackdrop.style.display = 'none';
    });

    helpModalBackdrop.addEventListener('click', (e) => {
      if (e.target === helpModalBackdrop) {
        helpModalBackdrop.style.display = 'none';
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        helpModalBackdrop.style.display = 'none';
        responsablesModalBackdrop.style.display = 'none';
      }
    });

    // ===========================
    // RESPONSABLES
    // ===========================
    const RESPONSABLES_KEY = 'responsables_lista_v1';
    function loadResponsablesLocal() {
      try {
        const raw = localStorage.getItem(RESPONSABLES_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return arr;
        return [];
      } catch (e) {
        return [];
      }
    }
    function saveResponsablesLocal() {
      localStorage.setItem(RESPONSABLES_KEY, JSON.stringify(responsablesList));
    }

    let responsablesList = loadResponsablesLocal();
    if (responsablesList.length === 0) {
      responsablesList = ['Responsable 1', 'Responsable 2'];
      saveResponsablesLocal();
    }

    function setResponsableForCell(cell, name) {
      cell.textContent = name;
      const rowIndex = Number(cell.dataset.row);
      if (!Number.isFinite(rowIndex)) return;
      state.rows[rowIndex].responsable = name;
      saveState();
      aplicarFiltros();
    }

    let currentResponsableCell = null;

    function openResponsableMenu(cell) {
      currentResponsableCell = cell;
      responsableMenuList.innerHTML = '';

      responsablesList.forEach((name) => {
        const div = document.createElement('div');
        div.className = 'responsable-menu-item';
        div.textContent = name;
        div.addEventListener('click', () => {
          setResponsableForCell(cell, name);
          hideResponsableMenu();
        });
        responsableMenuList.appendChild(div);
      });

      const rect = cell.getBoundingClientRect();
      const scrollX = window.scrollX || window.pageXOffset;
      const scrollY = window.scrollY || window.pageYOffset;
      responsableMenu.style.left = (rect.left + scrollX) + 'px';
      responsableMenu.style.top = (rect.bottom + scrollY + 4) + 'px';
      responsableMenu.style.display = 'block';
    }

    function hideResponsableMenu() {
      responsableMenu.style.display = 'none';
      currentResponsableCell = null;
    }

    document.addEventListener('click', (e) => {
      const cell = e.target.closest('td.cell-responsable');
      if (cell) {
        openResponsableMenu(cell);
      } else if (!e.target.closest('#responsableMenu')) {
        hideResponsableMenu();
      }
    });

    responsableMenuEdit.addEventListener('click', () => {
      hideResponsableMenu();
      openResponsablesModal();
    });

    responsableMenuAdd.addEventListener('click', () => {
      hideResponsableMenu();
      responsablesList.push('');
      openResponsablesModal();
    });

    function renderResponsablesEditList() {
      responsablesEditList.innerHTML = '';
      responsablesList.forEach((name, idx) => {
        const row = document.createElement('div');
        row.className = 'responsables-list-row';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = name;

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Eliminar';
        delBtn.addEventListener('click', () => {
          responsablesList.splice(idx, 1);
          renderResponsablesEditList();
        });

        row.appendChild(input);
        row.appendChild(delBtn);
        responsablesEditList.appendChild(row);
      });
    }

    function openResponsablesModal() {
      renderResponsablesEditList();
      responsablesModalBackdrop.style.display = 'flex';
    }

    function closeResponsablesModal() {
      responsablesModalBackdrop.style.display = 'none';
    }

    responsablesModalClose.addEventListener('click', closeResponsablesModal);
    responsablesCancel.addEventListener('click', closeResponsablesModal);

    responsablesAddRow.addEventListener('click', () => {
      responsablesList.push('');
      renderResponsablesEditList();
    });

    responsablesSave.addEventListener('click', () => {
      const inputs = responsablesEditList.querySelectorAll('input');
      const nueva = [];
      inputs.forEach((inp) => {
        const val = inp.value.trim();
        if (val) nueva.push(val);
      });
      responsablesList = nueva;
      saveResponsablesLocal();
      rellenarComboResponsables();
      closeResponsablesModal();
    });

    responsablesModalBackdrop.addEventListener('click', (e) => {
      if (e.target === responsablesModalBackdrop) {
        closeResponsablesModal();
      }
    });

    // ===========================
    // INICIALIZACI√ìN
    // ===========================
    async function init() {
      const { data, error } = await supabaseClient.auth.getSession();
      if (error) {
        console.error(error);
      }
      if (!data || !data.session) {
        window.location.href = 'index.html';
        return;
      }

      currentUser = data.session.user;
      storageKey = 'seguimiento_reuniones_' + currentUser.id;

      userLabel.textContent = currentUser.email || 'Usuario';

      loadState();

      if (!Array.isArray(state.responsables) || state.responsables.length === 0) {
        state.responsables = [];
      }
      if (!Array.isArray(state.rows)) state.rows = [];
      if (!Array.isArray(state.meetings)) state.meetings = [];
      if (!state.comments) state.comments = {};

      renderHeader();
      renderBody();
      rellenarComboResponsables();
    }

    init();
  </script>
</body>
</html>
