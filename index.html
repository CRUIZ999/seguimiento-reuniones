<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento de reuniones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
  />
  <style>
    :root {
      --bg: #f4f4f7;
      --card-bg: #ffffff;
      --border: #e1e4ea;
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --danger: #ef4444;
      --text-main: #111827;
      --text-soft: #6b7280;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      --shadow-table: 0 10px 30px rgba(15, 23, 42, 0.06);
      --yellow: #facc15;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5edff 0, #f9fafb 45%, #f4f4f7 100%);
      color: var(--text-main);
    }

    button {
      font-family: inherit;
      cursor: pointer;
    }

    input,
    select {
      font-family: inherit;
    }

    /* ===== LOGIN ===== */

    #login-root {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
    }

    #login-card {
      width: 100%;
      max-width: 420px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 32px 32px 28px;
    }

    #login-card h1 {
      margin: 0 0 4px;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    #login-card p.subtitle {
      margin: 0 0 24px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .field-label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .field {
      margin-bottom: 16px;
    }

    .field input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 9px 14px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .login-actions {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s, box-shadow 0.15s, transform 0.05s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-0.5px);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.45);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .login-note {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .error-banner {
      margin-bottom: 10px;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
      display: none;
    }

    /* ===== APP (TABLERO) ===== */

    #app-root {
      min-height: 100vh;
      padding: 24px 20px 26px;
      display: none;
    }

    .app-shell {
      max-width: 1280px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .app-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .app-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 3px;
    }

    .help-icon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      color: var(--text-soft);
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.1);
      user-select: none;
    }

    .help-icon:hover {
      background: #f9fafb;
    }

    .toolbar {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-table);
      padding: 10px 14px 12px;
      margin-bottom: 14px;
    }

    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .toolbar-row:last-child {
      margin-bottom: 0;
    }

    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 6px 12px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .btn-icon-only {
      width: 32px;
      height: 32px;
      padding: 0;
      justify-content: center;
    }

    .toolbar select,
    .toolbar input[type="text"] {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 13px;
      background: white;
      min-width: 120px;
    }

    .toolbar input[type="checkbox"] {
      margin-right: 4px;
    }

    .toolbar label {
      font-size: 12px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
    }

    /* ===== TABLE ===== */

    .table-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-table);
      overflow: hidden;
    }

    .table-wrapper {
      max-height: calc(100vh - 220px);
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 13px;
    }

    thead {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    th,
    td {
      border-bottom: 1px solid #eef0f4;
      padding: 6px 8px;
      text-align: left;
      position: relative;
    }

    th {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
      white-space: nowrap;
    }

    td {
      background: #ffffff;
      vertical-align: top;
    }

    tr:nth-child(even) td {
      background: #fbfdff;
    }

    td.editable {
      cursor: text;
    }

    td.editable:focus-within {
      outline: 2px solid #bfdbfe;
      outline-offset: -2px;
    }

    td > div.cell-input {
      min-height: 20px;
      padding: 1px 0;
      outline: none;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* sticky primeras 5 columnas */
    th.sticky-0,
    td.sticky-0 {
      position: sticky;
      left: 0;
      z-index: 1;
      background: inherit;
    }
    th.sticky-1,
    td.sticky-1 {
      position: sticky;
      left: 140px;
      z-index: 1;
      background: inherit;
    }
    th.sticky-2,
    td.sticky-2 {
      position: sticky;
      left: 360px;
      z-index: 1;
      background: inherit;
    }
    th.sticky-3,
    td.sticky-3 {
      position: sticky;
      left: 540px;
      z-index: 1;
      background: inherit;
    }
    th.sticky-4,
    td.sticky-4 {
      position: sticky;
      left: 650px;
      z-index: 1;
      background: inherit;
    }

    th.sticky-0,
    th.sticky-1,
    th.sticky-2,
    th.sticky-3,
    th.sticky-4 {
      z-index: 3;
    }
    td.sticky-0,
    td.sticky-1,
    td.sticky-2,
    td.sticky-3,
    td.sticky-4 {
      z-index: 2;
    }

    /* ESTADO */
    select.estado-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 3px 8px;
      font-size: 12px;
      color: #111827;
    }

    .estado-P {
      background: #fee2e2;
      border-color: #fecaca;
    }
    .estado-EP {
      background: #fef9c3;
      border-color: #facc15;
    }
    .estado-T {
      background: #dcfce7;
      border-color: #4ade80;
    }

    /* RESPONSABLE */
    select.resp-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 3px 8px;
      font-size: 12px;
    }

    /* COMENTARIOS */
    td.has-comment::after {
      content: "";
      position: absolute;
      right: 2px;
      top: 2px;
      border-width: 6px 6px 0 0;
      border-style: solid;
      border-color: var(--yellow) transparent transparent transparent;
    }

    /* FOOTER NOTE */
    .footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .footer-note span {
      white-space: nowrap;
    }

    /* HELP MODAL */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      background: white;
      border-radius: 18px;
      max-width: 640px;
      width: 100%;
      padding: 18px 20px 18px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      max-height: 80vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-close {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 15px;
    }

    .modal-content {
      font-size: 13px;
      color: #374151;
    }

    .modal-content h4 {
      margin: 12px 0 4px;
      font-size: 13px;
      font-weight: 600;
    }

    .modal-content ul {
      margin: 4px 0 8px 16px;
      padding-left: 0;
    }

    .modal-content li {
      margin-bottom: 3px;
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-root">
    <div id="login-card">
      <div id="error-banner" class="error-banner"></div>
      <h1>Seguimiento de reuniones</h1>
      <p class="subtitle">
        Inicia sesi√≥n con tu correo y contrase√±a para acceder al tablero.
      </p>

      <form id="login-form">
        <div class="field">
          <div class="field-label">Correo</div>
          <input
            id="email"
            type="email"
            placeholder="tucorreo@ejemplo.com"
            autocomplete="email"
            required
          />
        </div>

        <div class="field">
          <div class="field-label">Contrase√±a</div>
          <input
            id="password"
            type="password"
            autocomplete="current-password"
            required
          />
        </div>

        <div class="login-actions">
          <button type="submit" class="btn btn-primary">
            Entrar
          </button>
          <button type="button" id="btn-signup" class="btn btn-secondary">
            Crear cuenta
          </button>
        </div>
      </form>

      <p class="login-note">
        Esta sesi√≥n se cierra autom√°ticamente al cerrar la pesta√±a o recargar la
        p√°gina.
      </p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-root">
    <div class="app-shell">
      <div class="app-header">
        <div>
          <div class="app-title">Seguimiento de tareas y reuniones</div>
          <div class="app-subtitle">
            Columnas base: tema, sub tema, responsable, estado, fecha de t√©rmino.
          </div>
        </div>
        <div id="help-icon" class="help-icon" title="Doble clic para ver ayuda">?</div>
      </div>

      <div class="toolbar">
        <div class="toolbar-row">
          <div class="toolbar-group">
            <button id="btn-add-row" class="btn btn-primary">
              + Fila
            </button>
            <button id="btn-add-meeting" class="btn btn-ghost">
              + Columna
            </button>
            <button id="btn-save" class="btn btn-ghost btn-icon-only" title="Guardar en este navegador">
              üíæ
            </button>
            <button id="btn-export" class="btn btn-ghost" title="Exportar JSON">
              ‚¨áÔ∏è Exp
            </button>
            <button id="btn-import" class="btn btn-ghost" title="Importar JSON">
              ‚¨ÜÔ∏è Imp
            </button>
          </div>

          <div class="toolbar-group" style="margin-left:auto;">
            <label>
              Estado:
              <select id="filter-estado">
                <option value="todos">Todos</option>
                <option value="P">P</option>
                <option value="EP">EP</option>
                <option value="T">T</option>
              </select>
            </label>
            <label>
              Ocultar terminados
              <input type="checkbox" id="chk-hide-done" />
            </label>
          </div>
        </div>

        <div class="toolbar-row">
          <div class="toolbar-group">
            <select id="search-column">
              <option value="all">Todas las columnas</option>
              <option value="tema">tema</option>
              <option value="subtema">sub tema</option>
              <option value="responsable">responsable</option>
              <option value="estado">estado</option>
              <option value="fechaTermino">fecha de t√©rmino</option>
            </select>
            <input
              type="text"
              id="search-text"
              placeholder="Escribe una palabra o frase"
            />
            <button id="btn-apply-filter" class="btn btn-ghost">
              Filtro
            </button>
            <button id="btn-clear-filter" class="btn btn-ghost">
              Quitar filtro
            </button>
          </div>

          <div class="toolbar-group" style="margin-left:auto;">
            <span style="font-size:12px;color:var(--text-soft);">
              Columnas de reuniones:
            </span>
            <button id="btn-last-two" class="btn btn-ghost">
              √öltimas 2
            </button>
            <button id="btn-today-only" class="btn btn-ghost">
              Solo hoy
            </button>
          </div>
        </div>
      </div>

      <div class="table-card">
        <div id="table-wrapper" class="table-wrapper">
          <table id="main-table">
            <thead>
              <tr id="header-row"></tr>
            </thead>
            <tbody id="body-rows"></tbody>
          </table>
        </div>
      </div>

      <div class="footer-note">
        <span>‚úÖ Los datos (incluyendo comentarios) se guardan en este navegador.</span>
        <span>‚¨áÔ∏è Exporta el JSON para usarlo en otra computadora; luego ‚¨ÜÔ∏è imp√≥rtalo.</span>
        <span>üí¨ Clic derecho en una celda para agregar o borrar comentario.</span>
        <span>üîó Si una celda de "sub tema" solo tiene un link de Google Drive, doble clic lo abrir√°.</span>
      </div>
    </div>
  </div>

  <!-- MODAL DE AYUDA -->
  <div id="help-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Ayuda r√°pida</div>
        <button id="help-close" class="modal-close">‚úï</button>
      </div>
      <div class="modal-content">
        <h4>Estructura b√°sica</h4>
        <ul>
          <li><strong>Columnas base:</strong> tema, sub tema, responsable, estado, fecha de t√©rmino.</li>
          <li>Cada nueva reuni√≥n agrega una columna con la fecha del d√≠a.</li>
        </ul>

        <h4>Edici√≥n</h4>
        <ul>
          <li>Haz clic en las celdas para escribir y editar texto.</li>
          <li>En <strong>estado</strong> usa P (Pendiente), EP (En proceso), T (Terminado).</li>
          <li>En <strong>sub tema</strong>, si la celda s√≥lo tiene una URL de Google Drive, con doble clic se abrir√° en una pesta√±a nueva.</li>
        </ul>

        <h4>Comentarios</h4>
        <ul>
          <li>Clic derecho en cualquier celda para agregar o editar un comentario.</li>
          <li>Si dejas el comentario vac√≠o, se elimina.</li>
          <li>Las celdas con comentario muestran un tri√°ngulo amarillo peque√±o en la esquina superior derecha.</li>
        </ul>

        <h4>Filtros</h4>
        <ul>
          <li>Usa la barra de b√∫squeda para filtrar por texto en todas las columnas o s√≥lo en una.</li>
          <li>Filtra por <strong>estado</strong> y puedes elegir ocultar las filas terminadas (T).</li>
          <li>Los botones ‚Äú√öltimas 2‚Äù y ‚ÄúSolo hoy‚Äù ocultan/ muestran columnas de reuniones seg√∫n la fecha.</li>
        </ul>

        <h4>Guardado y portabilidad</h4>
        <ul>
          <li>La informaci√≥n se guarda autom√°ticamente en tu navegador usando localStorage.</li>
          <li>Con <strong>üíæ</strong> fuerzas un guardado manual inmediato.</li>
          <li>Con <strong>‚¨áÔ∏è Exp</strong> descargas un JSON con tus datos.</li>
          <li>Con <strong>‚¨ÜÔ∏è Imp</strong> puedes importar ese JSON en otra computadora o navegador.</li>
        </ul>

        <h4>Cuentas de acceso</h4>
        <ul>
          <li>El acceso al tablero est√° protegido con usuario y contrase√±a (Supabase Auth).</li>
          <li>Cada vez que abras la p√°gina deber√°s iniciar sesi√≥n de nuevo.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- L√ìGICA: LOGIN + TABLERO -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/esm/supabase.js";

    /********** SUPABASE: LOGIN **********/
    const supabaseUrl =
      "https://hrbmstaklleraiacqmky.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyYm1zdGFrbGxlcmFpYWNxbWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTA2OTQsImV4cCI6MjA3ODc4NjY5NH0.tN00tAjMJpJK_8gnerocbOSzHp93N5yc9KohTBpMeZc";

    const supabase = createClient(supabaseUrl, supabaseKey, {
      auth: {
        persistSession: false, // siempre pedir√° login al recargar
      },
    });

    const loginRoot = document.getElementById("login-root");
    const appRoot = document.getElementById("app-root");
    const loginForm = document.getElementById("login-form");
    const signupBtn = document.getElementById("btn-signup");
    const errorBanner = document.getElementById("error-banner");

    function showError(message) {
      errorBanner.textContent = message;
      errorBanner.style.display = "block";
    }

    function clearError() {
      errorBanner.textContent = "";
      errorBanner.style.display = "none";
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearError();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!email || !password) {
        showError("Escribe tu correo y contrase√±a.");
        return;
      }

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          console.error(error);
          showError("Error al iniciar sesi√≥n: " + error.message);
          return;
        }

        // login OK
        loginRoot.style.display = "none";
        appRoot.style.display = "block";
      } catch (err) {
        console.error(err);
        showError("Error inesperado al iniciar sesi√≥n.");
      }
    });

    signupBtn.addEventListener("click", async () => {
      clearError();
      const email = prompt("Correo del nuevo usuario:");
      if (!email) return;
      const password = prompt(
        "Contrase√±a para este usuario (m√≠nimo 6 caracteres):"
      );
      if (!password) return;

      try {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
        });

        if (error) {
          console.error(error);
          showError("Error al crear cuenta: " + error.message);
          return;
        }

        alert(
          "Cuenta creada correctamente. El usuario ya puede iniciar sesi√≥n con ese correo y contrase√±a."
        );
      } catch (err) {
        console.error(err);
        showError("Error inesperado al crear la cuenta.");
      }
    });

    /********** TABLERO EN LOCALSTORAGE **********/
    const STORAGE_KEY = "seguimiento_reuniones_v1";

    const baseColumns = [
      { id: "tema", label: "tema", sticky: 0, width: 140 },
      { id: "subtema", label: "sub tema", sticky: 1, width: 220 },
      { id: "responsable", label: "responsable", sticky: 2, width: 180 },
      { id: "estado", label: "estado", sticky: 3, width: 110 },
      { id: "fechaTermino", label: "fecha de termino", sticky: 4, width: 120 },
    ];

    let meetingColumns = []; // {id,label,dateISO}
    let rows = []; // {id, tema, subtema, responsable, estado, fechaTermino, reuniones:{colId: texto}}
    let comments = {}; // key: rowId|colId => texto

    const headerRow = document.getElementById("header-row");
    const bodyRows = document.getElementById("body-rows");

    const filterEstado = document.getElementById("filter-estado");
    const hideDone = document.getElementById("chk-hide-done");
    const searchColumn = document.getElementById("search-column");
    const searchText = document.getElementById("search-text");

    const btnAddRow = document.getElementById("btn-add-row");
    const btnAddMeeting = document.getElementById("btn-add-meeting");
    const btnSave = document.getElementById("btn-save");
    const btnExport = document.getElementById("btn-export");
    const btnImport = document.getElementById("btn-import");
    const btnApplyFilter = document.getElementById("btn-apply-filter");
    const btnClearFilter = document.getElementById("btn-clear-filter");
    const btnLastTwo = document.getElementById("btn-last-two");
    const btnTodayOnly = document.getElementById("btn-today-only");

    /***** helpers *****/
    function createId() {
      return (
        Date.now().toString(36) + Math.random().toString(36).substring(2, 8)
      );
    }

    function formatDateLabel(d) {
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    function saveAll() {
      const payload = {
        baseColumns,
        meetingColumns,
        rows,
        comments,
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function loadAll() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // datos iniciales
        rows = [
          {
            id: createId(),
            tema: "",
            subtema: "",
            responsable: "",
            estado: "P",
            fechaTermino: "",
            reuniones: {},
          },
        ];
        meetingColumns = [];
        comments = {};
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        meetingColumns = parsed.meetingColumns || [];
        rows = parsed.rows || [];
        comments = parsed.comments || {};
      } catch (e) {
        console.error("Error al leer localStorage", e);
        rows = [];
        meetingColumns = [];
        comments = {};
      }
    }

    /***** renderizado *****/
    function renderHeader() {
      headerRow.innerHTML = "";
      [...baseColumns, ...meetingColumns].forEach((col, index) => {
        const th = document.createElement("th");
        th.textContent = col.label;
        if (typeof col.width === "number") {
          th.style.minWidth = col.width + "px";
        }
        if (col.sticky != null) {
          th.classList.add(`sticky-${col.sticky}`);
        }
        headerRow.appendChild(th);
      });
    }

    function getComment(rowId, colId) {
      return comments[`${rowId}|${colId}`] || "";
    }

    function setComment(rowId, colId, texto) {
      const key = `${rowId}|${colId}`;
      if (!texto) {
        delete comments[key];
      } else {
        comments[key] = texto;
      }
      saveAll();
      renderBody();
    }

    function cellMatchesFilter(row, col) {
      const text = (row[col.id] || "").toString().toLowerCase();
      const search = searchText.value.trim().toLowerCase();
      if (!search) return true;
      return text.includes(search);
    }

    function rowVisible(row) {
      // filtro estado
      const est = filterEstado.value;
      if (est !== "todos" && row.estado !== est) return false;
      if (hideDone.checked && row.estado === "T") return false;

      // filtro de texto
      const search = searchText.value.trim().toLowerCase();
      if (!search) return true;

      const colSel = searchColumn.value;
      if (colSel === "all") {
        // revisar base + reuniones
        for (const col of baseColumns) {
          const value = (row[col.id] || "").toString().toLowerCase();
          if (value.includes(search)) return true;
        }
        for (const col of meetingColumns) {
          const value = (row.reuniones?.[col.id] || "")
            .toString()
            .toLowerCase();
          if (value.includes(search)) return true;
        }
        return false;
      } else if (colSel === "tema" || colSel === "subtema" || colSel === "responsable" || colSel === "estado" || colSel === "fechaTermino") {
        const val = (row[colSel] || "").toString().toLowerCase();
        return val.includes(search);
      } else {
        return true;
      }
    }

    function renderBody() {
      bodyRows.innerHTML = "";

      rows.forEach((row) => {
        const tr = document.createElement("tr");
        if (!rowVisible(row)) {
          tr.style.display = "none";
        }

        [...baseColumns, ...meetingColumns].forEach((col) => {
          const td = document.createElement("td");

          if (col.sticky != null) {
            td.classList.add(`sticky-${col.sticky}`);
          }

          // comentario
          if (getComment(row.id, col.id)) {
            td.classList.add("has-comment");
          }

          if (col.id === "estado") {
            const select = document.createElement("select");
            select.className = "estado-select";
            ["P", "EP", "T"].forEach((opt) => {
              const o = document.createElement("option");
              o.value = opt;
              o.textContent = opt;
              if (row.estado === opt) o.selected = true;
              select.appendChild(o);
            });
            function applyEstadoClass() {
              select.classList.remove("estado-P", "estado-EP", "estado-T");
              if (select.value === "P") select.classList.add("estado-P");
              if (select.value === "EP") select.classList.add("estado-EP");
              if (select.value === "T") select.classList.add("estado-T");
            }
            applyEstadoClass();
            select.addEventListener("change", () => {
              row.estado = select.value;
              applyEstadoClass();
              saveAll();
              renderBody();
            });
            td.appendChild(select);
          } else if (col.id === "responsable") {
            const select = document.createElement("select");
            select.className = "resp-select";
            const responsables = [
              "",
              "carlos",
              "deniss",
              "fernando",
              "jose",
              "otro",
            ];
            responsables.forEach((name) => {
              const o = document.createElement("option");
              o.value = name;
              o.textContent = name || "(sin responsable)";
              if (row.responsable === name) o.selected = true;
              select.appendChild(o);
            });
            select.addEventListener("change", () => {
              row.responsable = select.value;
              saveAll();
            });
            td.appendChild(select);
          } else if (col.id === "fechaTermino") {
            const div = document.createElement("div");
            div.className = "cell-input";
            div.contentEditable = "true";
            div.textContent = row.fechaTermino || "";
            div.addEventListener("blur", () => {
              row.fechaTermino = div.textContent.trim();
              saveAll();
            });
            td.classList.add("editable");
            td.appendChild(div);
          } else if (col.id === "tema" || col.id === "subtema") {
            const div = document.createElement("div");
            div.className = "cell-input";
            div.contentEditable = "true";
            div.textContent = row[col.id] || "";
            div.addEventListener("blur", () => {
              row[col.id] = div.textContent.trim();
              saveAll();
            });

            if (col.id === "subtema") {
              // doble clic: si es s√≥lo un link de drive, abrir
              div.addEventListener("dblclick", () => {
                const text = div.textContent.trim();
                if (
                  /^https?:\/\/(drive\.google\.com|docs\.google\.com)/i.test(
                    text
                  )
                ) {
                  window.open(text, "_blank");
                }
              });
            }

            td.classList.add("editable");
            td.appendChild(div);
          } else {
            // reuniones
            const div = document.createElement("div");
            div.className = "cell-input";
            div.contentEditable = "true";
            const value = row.reuniones?.[col.id] || "";
            div.textContent = value;
            div.addEventListener("blur", () => {
              if (!row.reuniones) row.reuniones = {};
              row.reuniones[col.id] = div.textContent.trim();
              saveAll();
            });
            td.classList.add("editable");
            td.appendChild(div);
          }

          // comentario con clic derecho
          td.addEventListener("contextmenu", (ev) => {
            ev.preventDefault();
            const actual = getComment(row.id, col.id);
            const nuevo = prompt(
              "Comentario para esta celda (d√©jalo vac√≠o para borrar):",
              actual
            );
            if (nuevo === null) return;
            setComment(row.id, col.id, nuevo.trim());
          });

          tr.appendChild(td);
        });

        bodyRows.appendChild(tr);
      });
    }

    /***** acciones *****/
    btnAddRow.addEventListener("click", () => {
      rows.push({
        id: createId(),
        tema: "",
        subtema: "",
        responsable: "",
        estado: "P",
        fechaTermino: "",
        reuniones: {},
      });
      saveAll();
      renderBody();
    });

    btnAddMeeting.addEventListener("click", () => {
      const now = new Date();
      const id = now.toISOString().slice(0, 10); // YYYY-MM-DD
      const label = formatDateLabel(now);
      meetingColumns.push({ id, label });
      saveAll();
      renderHeader();
      renderBody();
    });

    btnSave.addEventListener("click", () => {
      saveAll();
      alert("Datos guardados en este navegador.");
    });

    btnExport.addEventListener("click", () => {
      const payload = {
        meetingColumns,
        rows,
        comments,
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "seguimiento_reuniones.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener("click", () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.addEventListener("change", () => {
        const file = inp.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            meetingColumns = parsed.meetingColumns || [];
            rows = parsed.rows || [];
            comments = parsed.comments || {};
            saveAll();
            renderHeader();
            renderBody();
          } catch (e) {
            alert("Archivo JSON no v√°lido");
          }
        };
        reader.readAsText(file);
      });
      inp.click();
    });

    btnApplyFilter.addEventListener("click", () => {
      renderBody();
    });

    btnClearFilter.addEventListener("click", () => {
      searchText.value = "";
      searchColumn.value = "all";
      filterEstado.value = "todos";
      hideDone.checked = false;
      renderBody();
    });

    filterEstado.addEventListener("change", renderBody);
    hideDone.addEventListener("change", renderBody);

    btnLastTwo.addEventListener("click", () => {
      if (meetingColumns.length <= 2) {
        renderHeader();
        renderBody();
        return;
      }
      const lastTwoIds = meetingColumns
        .slice(-2)
        .map((c) => c.id);
      meetingColumns.forEach((col) => {
        col.hidden = !lastTwoIds.includes(col.id);
      });
      // filtramos s√≥lo para vista
      const visible = meetingColumns.filter((c) => !c.hidden);
      const hidden = meetingColumns.filter((c) => c.hidden);
      meetingColumns = [...visible, ...hidden]; // reordenamos: primero visibles
      renderHeader();
      renderBody();
    });

    btnTodayOnly.addEventListener("click", () => {
      const todayISO = new Date().toISOString().slice(0, 10);
      meetingColumns.forEach((col) => {
        col.hidden = col.id !== todayISO;
      });
      const visible = meetingColumns.filter((c) => !c.hidden);
      const hidden = meetingColumns.filter((c) => c.hidden);
      meetingColumns = [...visible, ...hidden];
      renderHeader();
      renderBody();
    });

    /***** ayuda modal *****/
    const helpIcon = document.getElementById("help-icon");
    const helpBackdrop = document.getElementById("help-backdrop");
    const helpClose = document.getElementById("help-close");

    function openHelp() {
      helpBackdrop.style.display = "flex";
    }
    function closeHelp() {
      helpBackdrop.style.display = "none";
    }

    helpIcon.addEventListener("dblclick", openHelp);
    helpClose.addEventListener("click", closeHelp);
    helpBackdrop.addEventListener("click", (e) => {
      if (e.target === helpBackdrop) closeHelp();
    });

    /***** inicio *****/
    loadAll();
    renderHeader();
    renderBody();
  </script>
</body>
</html>
