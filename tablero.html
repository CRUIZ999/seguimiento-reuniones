<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento de tareas y reuniones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f5f6fb;
      --card-bg: #ffffff;
      --primary: #0f74ff;
      --primary-soft: #e6f0ff;
      --border-soft: #dde3f0;
      --text-main: #111827;
      --text-soft: #6b7280;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --radius-xl: 18px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1400px;
      margin: 20px auto 40px;
      padding: 0 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 20px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .title-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .user-info {
      font-size: 12px;
      color: var(--text-soft);
    }

    .user-email {
      font-weight: 600;
      color: var(--text-main);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 13px;
      padding: 6px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      background: #f3f4ff;
      color: var(--text-main);
      transition: background 0.15s, box-shadow 0.15s, border-color 0.15s,
        transform 0.05s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
      box-shadow: 0 8px 20px rgba(15, 116, 255, 0.25);
    }

    .btn-icon {
      padding-inline: 9px;
      justify-content: center;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .btn:hover {
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-outline {
      background: #fff;
      border-color: var(--border-soft);
      color: var(--text-soft);
    }

    .btn-outline-primary {
      background: #fff;
      border-color: var(--primary-soft);
      color: var(--primary);
    }

    .btn .icon {
      font-size: 14px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge-counter {
      font-size: 11px;
      background: #f9fafb;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid var(--border-soft);
      color: var(--text-soft);
      display: inline-flex;
      gap: 6px;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }

    .dot-pendiente {
      background: var(--warning);
    }

    .dot-proceso {
      background: #38bdf8;
    }

    .dot-terminado {
      background: var(--success);
    }

    /* Tabla */
    .table-wrapper {
      margin-top: 6px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f9fafb;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #edf0f6;
      vertical-align: top;
    }

    th {
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      position: relative;
      background: #f9fafb;
    }

    tbody tr:nth-child(even) {
      background: #fcfdff;
    }

    tbody tr:hover {
      background: #f4f6ff;
    }

    .col-tema {
      width: 18%;
    }

    .col-subtema {
      width: 27%;
    }

    .col-responsable {
      width: 17%;
    }

    .col-estado {
      width: 13%;
    }

    .col-fecha {
      width: 25%;
      max-width: 40ch; /* ~40 caracteres visibles hacia la derecha */
      word-wrap: break-word;
      white-space: normal;
    }

    .cell-input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 13px;
      padding: 3px 2px;
      outline: none;
      resize: none;
      font-family: inherit;
    }

    .cell-input::placeholder {
      color: #cbd5f5;
    }

    .estado-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 38px;
      padding: 4px 9px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .estado-P {
      background: #fef3c7;
      color: #92400e;
    }

    .estado-EP {
      background: #e0f2fe;
      color: #075985;
    }

    .estado-T {
      background: #dcfce7;
      color: #166534;
    }

    .estado-select {
      margin-left: 4px;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      font-size: 11px;
      background: white;
    }

    /* Header filters */
    .filter-input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 3px 6px;
      font-size: 11px;
      margin-top: 4px;
      outline: none;
    }

    .filter-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(15, 116, 255, 0.12);
    }

    .filter-select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 3px 6px;
      font-size: 11px;
      margin-top: 4px;
      background: #fff;
      outline: none;
    }

    .filter-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(15, 116, 255, 0.12);
    }

    .table-footer-note {
      font-size: 11px;
      color: var(--text-soft);
      padding-top: 6px;
    }

    .table-footer-note span {
      font-weight: 500;
    }

    .table-footer-note .check {
      color: var(--primary);
    }

    /* Date picker overlay */
    #datePickerOverlay {
      position: absolute;
      z-index: 20;
      transform: translateY(-50%);
    }
    #datePickerOverlay input {
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      padding: 4px 6px;
      font-size: 12px;
      background: #fff;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
    }

    /* Help modal */
    .help-icon-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      cursor: pointer;
      color: #6b7280;
      font-weight: 600;
      font-size: 15px;
      margin-left: 4px;
    }

    .help-icon-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      background: #fff;
      border-radius: 18px;
      max-width: 640px;
      width: calc(100% - 32px);
      padding: 18px 20px 18px;
      box-shadow: 0 18px 60px rgba(15, 23, 42, 0.35);
      max-height: 80vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-close {
      background: #f3f4ff;
      border-radius: 999px;
      border: none;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
    }

    .modal p {
      font-size: 13px;
      color: var(--text-soft);
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .modal ul {
      padding-left: 18px;
      margin: 4px 0 10px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .modal li {
      margin-bottom: 3px;
    }

    .modal strong {
      color: var(--text-main);
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .toolbar-right {
        align-self: stretch;
        justify-content: space-between;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="header-row">
        <div>
          <div class="title-group">
            <h1>Seguimiento de tareas y reuniones</h1>
            <button class="help-icon-btn" id="btnHelp" title="Ayuda">?</button>
          </div>
          <div class="subtitle">
            Columnas base: <strong>tema</strong>, <strong>sub tema</strong>, <strong>responsable</strong>,
            <strong>estado</strong>, <strong>fecha de término</strong>. Cada nueva reunión agrega una columna nueva.
          </div>
        </div>
        <div class="user-info">
          Usuario: <span class="user-email" id="userEmail"></span>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <button class="btn btn-primary" id="btnNuevaFila">
            <span class="icon">＋</span> Fila
          </button>
          <button class="btn btn-outline-primary" id="btnNuevaColumna">
            <span class="icon">▤</span> Columna
          </button>

          <button class="btn btn-outline" id="btnGestionResponsables">
            Responsables
          </button>

          <span class="badge-counter" id="resumenEstados">
            <span><span class="badge-dot dot-pendiente"></span> P: 0</span>
            <span><span class="badge-dot dot-proceso"></span> EP: 0</span>
            <span><span class="badge-dot dot-terminado"></span> T: 0</span>
          </span>
        </div>

        <div class="toolbar-right">
          <button class="btn btn-outline btn-icon" id="btnExportar" title="Exportar JSON">
            <span class="icon">⭳</span>
          </button>
          <button class="btn btn-outline btn-icon" id="btnImportar" title="Importar JSON">
            <span class="icon">⭱</span>
          </button>

          <input type="file" id="inputImportar" accept="application/json" style="display:none" />

          <button class="btn btn-danger" id="btnCerrarSesion">
            Cerrar sesión
          </button>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="tabla">
          <thead>
            <tr id="headerRow">
              <th class="col-tema">tema</th>
              <th class="col-subtema">sub tema</th>
              <th class="col-responsable">responsable</th>
              <th class="col-estado">estado</th>
              <th class="col-fecha">fecha de termino</th>
              <!-- columnas dinámicas de reuniones se insertan aquí -->
            </tr>
            <tr id="filterRow">
              <th><input class="filter-input" data-col="tema" placeholder="Filtrar tema" /></th>
              <th><input class="filter-input" data-col="subtema" placeholder="Filtrar sub tema" /></th>
              <th>
                <select class="filter-select" data-col="responsable" id="filtroResponsable">
                  <option value="">Todos</option>
                </select>
              </th>
              <th>
                <select class="filter-select" data-col="estado" id="filtroEstado">
                  <option value="">Todos</option>
                  <option value="P">P</option>
                  <option value="EP">EP</option>
                  <option value="T">T</option>
                </select>
              </th>
              <th><input class="filter-input" data-col="fecha" placeholder="Filtrar fecha" /></th>
              <!-- filtros dinámicos de reuniones -->
            </tr>
          </thead>
          <tbody id="tbody">
          </tbody>
        </table>
      </div>

      <div class="table-footer-note">
        <span class="check">✔</span>
        Los datos (incluyendo comentarios y lista de responsables) se guardan en este navegador, por usuario.
        Para usarlos en otra computadora, exporta el JSON e impórtalo en esta misma página.
      </div>
    </div>
  </div>

  <!-- Overlay del datepicker -->
  <div id="datePickerOverlay" style="display:none;">
    <input type="date" id="datePickerInput" />
  </div>

  <!-- Modal de ayuda -->
  <div class="modal-backdrop" id="helpModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Ayuda rápida del tablero</div>
        <button class="modal-close" id="helpModalClose">✕</button>
      </div>
      <p>
        Aquí puedes llevar el control de acuerdos, tareas y seguimientos de tus reuniones.
        Todo lo que edites se guarda automáticamente en tu navegador, ligado a tu correo.
      </p>

      <p><strong>Botones principales:</strong></p>
      <ul>
        <li><strong>＋ Fila</strong>: agrega una nueva fila a la tabla.</li>
        <li><strong>▤ Columna</strong>: agrega una nueva columna de reunión (escribe un título o fecha).</li>
        <li><strong>Responsables</strong>: administra la lista de responsables disponibles.</li>
        <li><strong>⭳</strong> Exportar: descarga un archivo JSON con toda la información del tablero.</li>
        <li><strong>⭱</strong> Importar: carga un archivo JSON previamente exportado.</li>
        <li><strong>Cerrar sesión</strong>: limpia la sesión actual y vuelve al login.</li>
      </ul>

      <p><strong>Columnas base:</strong></p>
      <ul>
        <li><strong>tema</strong>: asunto principal o categoría de la tarea.</li>
        <li><strong>sub tema</strong>: detalle o descripción de lo que se va a hacer.</li>
        <li><strong>responsable</strong>: persona encargada (elige de la lista desplegable).</li>
        <li><strong>estado</strong>:
          <strong>P</strong> (Pendiente),
          <strong>EP</strong> (En proceso),
          <strong>T</strong> (Terminado). Se muestra como pastilla de color.
        </li>
        <li><strong>fecha de término</strong>: fecha objetivo; al hacer clic se despliega un calendario.</li>
      </ul>

      <p><strong>Filtros:</strong></p>
      <ul>
        <li>En la segunda fila del encabezado puedes filtrar por cada columna (texto, responsable y estado).</li>
        <li>Los filtros se aplican en vivo a medida que escribes o cambias las opciones.</li>
      </ul>

      <p><strong>Notas:</strong></p>
      <ul>
        <li>Las columnas de reunión se agregan hacia la derecha y también se pueden filtrar por su contenido.</li>
        <li>El texto en “fecha de termino” tiene un ancho máximo aproximado de 40 caracteres y crece hacia abajo si es más largo.</li>
      </ul>
    </div>
  </div>

  <script>
    /********** SESIÓN **********/
    const userEmailSpan = document.getElementById('userEmail');
    const emailSesion = localStorage.getItem('usuarioEmail') || '';
    userEmailSpan.textContent = emailSesion || '(sin sesión)';

    // Aceptar diferentes formatos que pueda estar guardando el login
    const rawSesion = localStorage.getItem('sesionActiva');
    const sesionActiva = rawSesion === '1' || rawSesion === 'true' || rawSesion === 'YES';

    if (!sesionActiva) {
      alert('No hay sesión activa, vuelve a iniciar desde el login.');
      window.location.href = 'index.html';
    }

    /********** DATOS Y STORAGE **********/
    const STORAGE_KEY_PREFIX = 'tablero_reuniones_';
    const STORAGE_KEY = STORAGE_KEY_PREFIX + (emailSesion || 'anonimo');

    let filas = [];            // filas del tablero
    let columnasReunion = [];  // nombres de columnas extra

    const defaultResponsables = ['cruiz@elcedro.mx'];
    let listaResponsables =
      JSON.parse(localStorage.getItem('listaResponsables_' + emailSesion)) ||
      defaultResponsables.slice();

    function saveResponsables() {
      localStorage.setItem('listaResponsables_' + emailSesion, JSON.stringify(listaResponsables));
      poblarFiltroResponsable();
    }

    function cargarDesdeStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        filas = [];
        columnasReunion = [];
        return;
      }
      try {
        const obj = JSON.parse(raw);
        filas = obj.filas || [];
        columnasReunion = obj.columnasReunion || [];
      } catch (e) {
        console.error('Error leyendo storage', e);
        filas = [];
        columnasReunion = [];
      }
    }

    function guardarEnStorage() {
      const obj = { filas, columnasReunion };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      actualizarResumenEstados();
    }

    /********** UI BÁSICA **********/
    const tbody = document.getElementById('tbody');
    const headerRow = document.getElementById('headerRow');
    const filterRow = document.getElementById('filterRow');

    function crearFilaVacia() {
      const fila = {
        id: Date.now() + '_' + Math.random().toString(36).slice(2),
        tema: '',
        subtema: '',
        responsable: listaResponsables[0] || '',
        estado: 'P',
        fecha: '',
        reuniones: {}
      };
      columnasReunion.forEach(col => {
        fila.reuniones[col] = '';
      });
      filas.push(fila);
    }

    function renderColumnasReunion() {
      // limpia todas las TH extra
      while (headerRow.children.length > 5) headerRow.removeChild(headerRow.lastChild);
      while (filterRow.children.length > 5) filterRow.removeChild(filterRow.lastChild);

      columnasReunion.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        headerRow.appendChild(th);

        const thFilter = document.createElement('th');
        const input = document.createElement('input');
        input.className = 'filter-input';
        input.dataset.col = 'reunion:' + col;
        input.placeholder = 'Filtrar ' + col;
        thFilter.appendChild(input);
        filterRow.appendChild(thFilter);
      });
    }

    function crearCeldaTexto(fila, campo, claseOpcional) {
      const td = document.createElement('td');
      if (claseOpcional) td.classList.add(claseOpcional);

      const input = document.createElement('textarea');
      input.className = 'cell-input';
      input.value = fila[campo] || '';
      input.rows = 1;

      input.addEventListener('input', () => {
        fila[campo] = input.value;
        guardarEnStorage();
        aplicarFiltros();
      });

      td.appendChild(input);
      return td;
    }

    function crearCeldaResponsable(fila) {
      const td = document.createElement('td');
      const select = document.createElement('select');
      select.className = 'cell-input';

      listaResponsables.forEach(resp => {
        const opt = document.createElement('option');
        opt.value = resp;
        opt.textContent = resp;
        select.appendChild(opt);
      });

      select.value = fila.responsable || '';
      select.addEventListener('change', () => {
        fila.responsable = select.value;
        guardarEnStorage();
        aplicarFiltros();
      });

      td.appendChild(select);
      return td;
    }

    function crearCeldaEstado(fila) {
      const td = document.createElement('td');

      const btn = document.createElement('button');
      btn.className = 'estado-pill estado-' + fila.estado;
      btn.textContent = fila.estado;
      btn.type = 'button';

      btn.addEventListener('click', () => {
        const orden = ['P', 'EP', 'T'];
        const idx = orden.indexOf(fila.estado);
        fila.estado = orden[(idx + 1) % orden.length];
        btn.textContent = fila.estado;
        btn.className = 'estado-pill estado-' + fila.estado;
        guardarEnStorage();
        aplicarFiltros();
      });

      td.appendChild(btn);
      return td;
    }

    /** DATE PICKER **/
    const dateOverlay = document.getElementById('datePickerOverlay');
    const dateInput = document.getElementById('datePickerInput');
    let dateOverlayFila = null;

    function formatearFechaDisplay(iso) {
      if (!iso) return '';
      // iso: yyyy-mm-dd
      const [y, m, d] = iso.split('-');
      if (!y || !m || !d) return iso;
      return `${d}/${m}/${y.slice(2)}`;
    }

    function parseFechaDisplay(display) {
      // display: dd/mm/yy o dd/mm/yyyy
      if (!display) return '';
      const parts = display.split('/');
      if (parts.length !== 3) return '';
      let [d, m, y] = parts;
      if (y.length === 2) {
        y = '20' + y;
      }
      if (d.length === 1) d = '0' + d;
      if (m.length === 1) m = '0' + m;
      return `${y}-${m}-${d}`;
    }

    function crearCeldaFecha(fila) {
      const td = document.createElement('td');
      td.classList.add('col-fecha');

      const input = document.createElement('textarea');
      input.className = 'cell-input';
      input.readOnly = true;
      input.value = fila.fecha || '';
      input.rows = 1;

      td.addEventListener('click', (e) => {
        const rect = td.getBoundingClientRect();
        dateOverlay.style.display = 'block';
        dateOverlay.style.top = window.scrollY + rect.top + rect.height / 2 + 'px';
        dateOverlay.style.left = window.scrollX + rect.left + 'px';

        const iso = parseFechaDisplay(fila.fecha);
        if (iso) dateInput.value = iso;
        else dateInput.value = '';

        dateOverlayFila = fila;
        dateInput.focus();
        e.stopPropagation();
      });

      input.addEventListener('focus', (ev) => {
        ev.target.blur();
      });

      td.appendChild(input);
      return td;
    }

    document.addEventListener('click', (e) => {
      if (!dateOverlay.contains(e.target)) {
        dateOverlay.style.display = 'none';
        dateOverlayFila = null;
      }
    });

    dateInput.addEventListener('change', () => {
      if (!dateOverlayFila) return;
      const iso = dateInput.value;
      const display = formatearFechaDisplay(iso);
      dateOverlayFila.fecha = display;
      guardarEnStorage();
      renderFilas();
      dateOverlay.style.display = 'none';
      dateOverlayFila = null;
      aplicarFiltros();
    });

    function crearCeldaReunion(fila, nombreCol) {
      const td = document.createElement('td');
      const input = document.createElement('textarea');
      input.className = 'cell-input';
      input.value = (fila.reuniones && fila.reuniones[nombreCol]) || '';
      input.rows = 1;

      input.addEventListener('input', () => {
        if (!fila.reuniones) fila.reuniones = {};
        fila.reuniones[nombreCol] = input.value;
        guardarEnStorage();
        aplicarFiltros();
      });

      td.appendChild(input);
      return td;
    }

    function renderFilas() {
      tbody.innerHTML = '';
      filas.forEach(fila => {
        const tr = document.createElement('tr');
        tr.dataset.id = fila.id;

        tr.appendChild(crearCeldaTexto(fila, 'tema', 'col-tema'));
        tr.appendChild(crearCeldaTexto(fila, 'subtema', 'col-subtema'));
        tr.appendChild(crearCeldaResponsable(fila));
        tr.appendChild(crearCeldaEstado(fila));
        tr.appendChild(crearCeldaFecha(fila));

        columnasReunion.forEach(col => {
          tr.appendChild(crearCeldaReunion(fila, col));
        });

        tbody.appendChild(tr);
      });
    }

    function actualizarResumenEstados() {
      const span = document.getElementById('resumenEstados');
      const conteo = { P: 0, EP: 0, T: 0 };
      filas.forEach(f => {
        conteo[f.estado] = (conteo[f.estado] || 0) + 1;
      });
      span.innerHTML =
        `<span><span class="badge-dot dot-pendiente"></span> P: ${conteo.P || 0}</span>
         <span><span class="badge-dot dot-proceso"></span> EP: ${conteo.EP || 0}</span>
         <span><span class="badge-dot dot-terminado"></span> T: ${conteo.T || 0}</span>`;
    }

    /********** FILTROS POR ENCABEZADO **********/
    function obtenerValoresFiltros() {
      const filtros = {
        tema: document.querySelector('.filter-input[data-col="tema"]').value.trim().toLowerCase(),
        subtema: document.querySelector('.filter-input[data-col="subtema"]').value.trim().toLowerCase(),
        responsable: document.querySelector('.filter-select[data-col="responsable"]').value,
        estado: document.querySelector('.filter-select[data-col="estado"]').value,
        fecha: document.querySelector('.filter-input[data-col="fecha"]').value.trim().toLowerCase(),
        reuniones: {}
      };

      columnasReunion.forEach(col => {
        const inp = document.querySelector('.filter-input[data-col="reunion:' + col + '"]');
        filtros.reuniones[col] = inp ? inp.value.trim().toLowerCase() : '';
      });

      return filtros;
    }

    function filaCumpleFiltros(fila, filtros) {
      if (filtros.tema && !(fila.tema || '').toLowerCase().includes(filtros.tema)) return false;
      if (filtros.subtema && !(fila.subtema || '').toLowerCase().includes(filtros.subtema)) return false;
      if (filtros.responsable && fila.responsable !== filtros.responsable) return false;
      if (filtros.estado && fila.estado !== filtros.estado) return false;
      if (filtros.fecha && !(fila.fecha || '').toLowerCase().includes(filtros.fecha)) return false;

      for (const col of columnasReunion) {
        const filtroCol = filtros.reuniones[col];
        if (filtroCol) {
          const valor = (fila.reuniones && fila.reuniones[col]) ? fila.reuniones[col].toLowerCase() : '';
          if (!valor.includes(filtroCol)) return false;
        }
      }

      return true;
    }

    function aplicarFiltros() {
      const filtros = obtenerValoresFiltros();
      const trs = tbody.querySelectorAll('tr');
      trs.forEach(tr => {
        const id = tr.dataset.id;
        const fila = filas.find(f => f.id === id);
        if (!fila) return;
        tr.style.display = filaCumpleFiltros(fila, filtros) ? '' : 'none';
      });
      actualizarResumenEstados();
    }

    document.getElementById('filterRow').addEventListener('input', (ev) => {
      if (ev.target.matches('.filter-input') || ev.target.matches('.filter-select')) {
        aplicarFiltros();
      }
    });

    /********** RESPONSABLES **********/
    function poblarFiltroResponsable() {
      const sel = document.getElementById('filtroResponsable');
      const valorActual = sel.value;
      sel.innerHTML = '<option value="">Todos</option>';
      listaResponsables.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        sel.appendChild(opt);
      });
      if ([...sel.options].some(o => o.value === valorActual)) {
        sel.value = valorActual;
      }
    }

    function gestionarResponsables() {
      const actual = listaResponsables.join('\n');
      const texto = prompt(
        'Edita la lista de responsables (uno por línea):',
        actual
      );
      if (texto === null) return;
      const nuevos = texto
        .split('\n')
        .map(t => t.trim())
        .filter(t => t.length > 0);
      if (nuevos.length === 0) {
        alert('Debe haber al menos un responsable.');
        return;
      }
      listaResponsables = Array.from(new Set(nuevos));
      saveResponsables();
      guardarEnStorage();
      renderFilas();
    }

    /********** EXPORTAR / IMPORTAR **********/
    document.getElementById('btnExportar').addEventListener('click', () => {
      const data = { filas, columnasReunion, responsables: listaResponsables };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tablero_reuniones.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('btnImportar').addEventListener('click', () => {
      document.getElementById('inputImportar').click();
    });

    document.getElementById('inputImportar').addEventListener('change', (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          filas = data.filas || [];
          columnasReunion = data.columnasReunion || [];
          listaResponsables = data.responsables || listaResponsables;
          saveResponsables();
          renderColumnasReunion();
          renderFilas();
          guardarEnStorage();
          aplicarFiltros();
          alert('Datos importados correctamente.');
        } catch (err) {
          console.error(err);
          alert('Error al importar el archivo.');
        }
      };
      reader.readAsText(file);
      ev.target.value = '';
    });

    /********** NUEVA FILA / COLUMNA **********/
    document.getElementById('btnNuevaFila').addEventListener('click', () => {
      crearFilaVacia();
      guardarEnStorage();
      renderFilas();
      aplicarFiltros();
    });

    document.getElementById('btnNuevaColumna').addEventListener('click', () => {
      const nombre = prompt('Título de la nueva columna de reunión (ej. 16/11/25):', '');
      if (!nombre) return;
      if (columnasReunion.includes(nombre)) {
        alert('Ya existe una columna con ese nombre.');
        return;
      }
      columnasReunion.push(nombre);
      filas.forEach(f => {
        if (!f.reuniones) f.reuniones = {};
        f.reuniones[nombre] = '';
      });
      renderColumnasReunion();
      renderFilas();
      guardarEnStorage();
      aplicarFiltros();
    });

    /********** CERRAR SESIÓN **********/
    document.getElementById('btnCerrarSesion').addEventListener('click', () => {
      if (!confirm('¿Cerrar sesión?')) return;
      localStorage.removeItem('sesionActiva');
      window.location.href = 'index.html';
    });

    /********** AYUDA (MODAL) **********/
    const helpBackdrop = document.getElementById('helpModalBackdrop');
    document.getElementById('btnHelp').addEventListener('click', () => {
      helpBackdrop.style.display = 'flex';
    });
    document.getElementById('helpModalClose').addEventListener('click', () => {
      helpBackdrop.style.display = 'none';
    });
    helpBackdrop.addEventListener('click', (ev) => {
      if (ev.target === helpBackdrop) {
        helpBackdrop.style.display = 'none';
      }
    });

    /********** INICIALIZACIÓN **********/
    function init() {
      poblarFiltroResponsable();
      cargarDesdeStorage();
      renderColumnasReunion();
      if (filas.length === 0) {
        crearFilaVacia();
      }
      renderFilas();
      guardarEnStorage();
      aplicarFiltros();
    }

    document.getElementById('btnGestionResponsables').addEventListener('click', gestionarResponsables);

    init();
  </script>
</body>
</html>
