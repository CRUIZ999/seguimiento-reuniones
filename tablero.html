<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento de tareas y reuniones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --azul: #0f6cf5;
      --azul-claro: #e7f1ff;
      --gris-borde: #e1e4e8;
      --gris-fondo: #f6f8fa;
      --gris-texto: #586069;
      --rojo: #ff4b4b;
      --verde: #1f883d;
      --amarillo: #f5b800;
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
        sans-serif;
    }

    body {
      margin: 0;
      background: #ffffff;
      color: #111827;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--gris-fondo);
    }

    header {
      padding: 16px 24px 8px;
      background: #ffffff;
      border-bottom: 1px solid var(--gris-borde);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
    }

    .user-info {
      font-size: 13px;
      color: var(--gris-texto);
    }

    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .btn-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: 1px solid var(--gris-borde);
      background: #ffffff;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.12s ease, border-color 0.12s ease,
        box-shadow 0.12s ease, transform 0.06s ease;
    }

    button svg {
      width: 14px;
      height: 14px;
    }

    button:hover {
      background: #f3f4f6;
      border-color: #cbd5e1;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: inset 0 0 0 1px #e5e7eb;
    }

    .btn-primary {
      background: var(--azul);
      border-color: var(--azul);
      color: #ffffff;
    }

    .btn-primary:hover {
      background: #0c58c4;
      border-color: #0c58c4;
    }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
    }

    .btn-ghost:hover {
      background: #f3f4f6;
      border-color: transparent;
    }

    .chip-toggle {
      font-size: 12px;
      padding: 5px 12px;
    }

    .chip-toggle--active {
      background: var(--azul);
      border-color: var(--azul);
      color: #ffffff;
    }

    .toolbar-filters {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    .toolbar-filters span {
      color: var(--gris-texto);
    }

    .filter-select {
      border-radius: 999px;
      border: 1px solid var(--gris-borde);
      padding: 4px 10px;
      font-size: 13px;
      background: #ffffff;
      min-width: 120px;
    }

    main {
      flex: 1;
      padding: 12px 16px 20px;
      overflow: hidden;
    }

    .table-wrapper {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid var(--gris-borde);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 150px);
      min-height: 360px;
    }

    .table-scroll {
      flex: 1;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: fixed;
    }

    thead {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    th,
    td {
      border-bottom: 1px solid #edf1f5;
      padding: 6px 8px;
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-weight: 500;
      color: #4b5563;
      position: relative;
      background: #f9fafb;
      white-space: nowrap;
    }

    th .th-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    th .th-filter {
      font-size: 11px;
      color: var(--gris-texto);
      cursor: pointer;
      border-radius: 8px;
      padding: 1px 6px;
    }

    th .th-filter:hover {
      background: #e5e7eb;
    }

    th:first-child {
      padding-left: 16px;
    }

    td:first-child {
      padding-left: 16px;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    tr:hover td {
      background: #f2f6ff;
    }

    .td-input,
    .td-textarea {
      width: 100%;
      border-radius: 6px;
      border: 1px solid transparent;
      padding: 3px 6px;
      font-size: 13px;
      font-family: inherit;
      background: transparent;
      resize: none;
    }

    .td-input:focus,
    .td-textarea:focus {
      outline: none;
      border-color: var(--azul);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(15, 108, 245, 0.08);
    }

    .td-textarea {
      min-height: 28px;
      max-height: none; /* sin l√≠mite hacia abajo */
    }

    .td-fecha {
      max-width: 160px; /* limita horizontalmente ~40 caracteres aprox */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .select-estado,
    .select-responsable {
      width: 100%;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 3px 8px;
      font-size: 13px;
      font-family: inherit;
      background: #f3f4f6;
      cursor: pointer;
    }

    .select-estado:focus,
    .select-responsable:focus {
      outline: none;
      border-color: var(--azul);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(15, 108, 245, 0.08);
    }

    .badge-estado {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      color: #ffffff;
    }

    .estado-P {
      background: var(--amarillo);
    }

    .estado-EP {
      background: var(--azul);
    }

    .estado-T {
      background: var(--verde);
    }

    .footer-info {
      padding: 6px 12px 8px;
      font-size: 11px;
      color: var(--gris-texto);
      border-top: 1px solid #edf1f5;
      background: #fafafa;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .footer-info input[type='checkbox'] {
      width: 12px;
      height: 12px;
    }

    .info-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--verde);
    }

    .icon-only {
      padding: 6px 8px;
      width: 32px;
      justify-content: center;
    }

    .icon-only svg {
      width: 15px;
      height: 15px;
    }

    .right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* modal ayuda */
    .help-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--gris-borde);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      background: #ffffff;
      color: var(--gris-texto);
    }

    .help-icon:hover {
      background: #f3f4f6;
    }

    .help-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.25);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .help-modal {
      background: #ffffff;
      border-radius: 14px;
      padding: 18px 18px 14px;
      max-width: 640px;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
      font-size: 13px;
    }

    .help-modal h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .help-modal h3 {
      margin: 12px 0 4px;
      font-size: 14px;
    }

    .help-modal ul {
      margin: 0;
      padding-left: 18px;
    }

    .help-modal-close {
      float: right;
      border-radius: 999px;
      border: none;
      background: #f3f4f6;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .help-modal-close:hover {
      background: #e5e7eb;
    }

    /* mensajes */
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #111827;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 60;
    }

    .toast.show {
      display: inline-flex;
    }

    .toast-success {
      background: #16a34a;
    }

    .toast-error {
      background: #b91c1c;
    }

    @media (max-width: 768px) {
      header {
        padding: 12px 12px 8px;
      }

      main {
        padding: 8px;
      }

      .table-wrapper {
        height: calc(100vh - 140px);
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="header-top">
        <div>
          <div class="title">Seguimiento de tareas y reuniones</div>
          <div class="user-info">Usuario:
            <span id="userEmail">(sin sesi√≥n)</span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="help-icon" id="btnHelp" title="Ayuda">?</div>
        </div>
      </div>

      <div class="header-actions">
        <div class="btn-group">
          <button id="btnAddRow" class="btn-primary">
            + Fila
          </button>
          <button id="btnAddColumn">
            + Columna
          </button>

          <!-- exportar / importar s√≥lo iconos -->
          <button id="btnExport" class="icon-only" title="Exportar JSON">
            üì§
          </button>
          <button id="btnImport" class="icon-only" title="Importar JSON">
            üì•
          </button>
        </div>

        <div class="right-actions">
          <!-- filtros de fechas -->
          <div class="btn-group">
            <button id="btnFiltroTodos" class="chip-toggle chip-toggle--active">
              Todas
            </button>
            <button id="btnFiltroUltimas2" class="chip-toggle">
              √öltimas 2
            </button>
            <button id="btnFiltroHoy" class="chip-toggle">
              Solo hoy
            </button>
          </div>

          <!-- flechas + cerrar sesi√≥n -->
          <div class="btn-group">
            <button id="btnScrollLeft" class="icon-only" title="Desplazar columnas a la izquierda">
              ‚óÄ
            </button>
            <button id="btnScrollRight" class="icon-only" title="Desplazar columnas a la derecha">
              ‚ñ∂
            </button>

            <button id="btnLogout" class="btn-ghost" style="margin-left:4px;">
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="table-wrapper">
        <div class="table-scroll" id="tableScroll">
          <table id="tabla">
            <thead>
              <tr id="thead-row">
                <!-- Se llena por JS -->
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- Filas din√°micas -->
            </tbody>
          </table>
        </div>

        <div class="footer-info">
          <div class="info-dot"></div>
          <span>Los datos (incluyendo comentarios y lista de responsables) se guardan en este navegador, por
            usuario.</span>
        </div>
      </div>
    </main>
  </div>

  <!-- modal de ayuda -->
  <div class="help-modal-backdrop" id="helpBackdrop">
    <div class="help-modal">
      <button class="help-modal-close" id="btnHelpClose">√ó</button>
      <h2>Ayuda - Seguimiento de tareas y reuniones</h2>
      <p>Resumen de funciones principales del tablero.</p>

      <h3>Columnas base</h3>
      <ul>
        <li><b>tema</b>: asunto principal a tratar.</li>
        <li><b>sub tema</b>: detalle o tema secundario. Aqu√≠ puedes pegar un enlace de Google Drive; si la celda s√≥lo
          contiene una URL, al hacer doble clic se abre en otra pesta√±a.</li>
        <li><b>responsable</b>: persona a cargo (desplegable). Puedes gestionar la lista de responsables desde el men√∫
          ‚ÄúResponsables‚Äù.</li>
        <li><b>estado</b>: P (Pendiente), EP (En proceso), T (Terminado) con colores.</li>
        <li><b>fecha de t√©rmino</b>: fecha objetivo. Haz clic para seleccionar desde un calendario.</li>
      </ul>

      <h3>Filas y columnas</h3>
      <ul>
        <li><b>+ Fila</b>: agrega una nueva tarea.</li>
        <li><b>+ Columna</b>: agrega una columna de reuni√≥n (por ejemplo, una fecha de junta) al final de la tabla.</li>
      </ul>

      <h3>Filtros</h3>
      <ul>
        <li>En el encabezado de cada columna puedes filtrar escribiendo una palabra (la tabla se actualiza en
          autom√°tico).</li>
        <li>Usa los chips de fecha:
          <ul>
            <li><b>Todas</b>: muestra todas las columnas de reuni√≥n.</li>
            <li><b>√öltimas 2</b>: muestra s√≥lo las dos √∫ltimas columnas de reuni√≥n.</li>
            <li><b>Solo hoy</b>: muestra √∫nicamente la columna de reuni√≥n correspondiente a la fecha actual (si existe).
            </li>
          </ul>
        </li>
      </ul>

      <h3>Exportar / Importar</h3>
      <ul>
        <li>üì§ Exportar: descarga un archivo JSON con toda la informaci√≥n del tablero.</li>
        <li>üì• Importar: puedes cargar un archivo JSON previamente exportado para restaurar o copiar informaci√≥n.</li>
      </ul>

      <h3>Sesi√≥n</h3>
      <ul>
        <li><b>Cerrar sesi√≥n</b>: termina tu sesi√≥n actual. La pr√≥xima vez que entres se te pedir√° correo y contrase√±a.
        </li>
      </ul>
    </div>
  </div>

  <!-- mensajes flotantes -->
  <div id="toast" class="toast"></div>

  <script>
    /********** SESI√ìN **********/
    const userEmailSpan = document.getElementById('userEmail');
    const emailSesion = localStorage.getItem('usuarioEmail') || '';
    userEmailSpan.textContent = emailSesion || '(sin sesi√≥n)';

    if (localStorage.getItem('sesionActiva') !== '1') {
      alert('No hay sesi√≥n activa, vuelve a iniciar desde el login.');
      window.location.href = 'index.html';
    }

    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.removeItem('sesionActiva');
      localStorage.removeItem('usuarioEmail');
      window.location.href = 'index.html';
    });

    /********** UTILIDADES **********/
    const ESTADOS = ['P', 'EP', 'T'];

    const STORAGE_KEY = 'tablero_tareas_v3';
    const RESPONSABLES_KEY = 'tablero_responsables_v3';

    function showToast(msg, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast show';
      if (type === 'success') toast.classList.add('toast-success');
      if (type === 'error') toast.classList.add('toast-error');
      setTimeout(() => {
        toast.className = 'toast';
      }, 2200);
    }

    function hoyISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function isoToDDMMYY(iso) {
      if (!iso) return '';
      const [y, m, d] = iso.split('-');
      return `${d}/${m}/${y.slice(-2)}`;
    }

    function ddmmyyToISO(str) {
      if (!str) return '';
      const parts = str.split(/[\/\-]/);
      if (parts.length < 3) return '';
      let [d, m, y] = parts;
      if (y.length === 2) {
        const currentCentury = String(new Date().getFullYear()).slice(0, 2);
        y = currentCentury + y;
      }
      return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
    }

    /********** ESTADO DE LA APP **********/
    let responsables = [];
    let data = {
      columnasReunion: [], // [{id, tituloISO}]
      filas: [] // {tema, subTema, responsable, estado, fechaTerminoISO, reuniones:{colId: texto}}
    };

    function cargarDesdeStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) data = JSON.parse(raw);
      } catch (e) {
        console.error(e);
      }
      try {
        const rawR = localStorage.getItem(RESPONSABLES_KEY);
        if (rawR) responsables = JSON.parse(rawR);
        else responsables = ['cruiz@elcedro.mx'];
      } catch (e) {
        responsables = ['cruiz@elcedro.mx'];
      }
    }

    function guardarEnStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      localStorage.setItem(RESPONSABLES_KEY, JSON.stringify(responsables));
    }

    /********** UI: CABECERAS + FILTROS EN ENCABEZADO **********/
    const columnasBase = [
      { key: 'tema', label: 'tema', ancho: 180 },
      { key: 'subTema', label: 'sub tema', ancho: 220 },
      { key: 'responsable', label: 'responsable', ancho: 160 },
      { key: 'estado', label: 'estado', ancho: 100 },
      { key: 'fechaTermino', label: 'fecha de termino', ancho: 130 }
    ];

    const filtros = {
      tema: '',
      subTema: '',
      responsable: '',
      estado: '',
      fechaTermino: ''
    };

    let filtroFechaModo = 'todas'; // todas | ultimas2 | hoy

    function construirEncabezado() {
      const theadRow = document.getElementById('thead-row');
      theadRow.innerHTML = '';

      function creaTH(col) {
        const th = document.createElement('th');
        th.style.minWidth = col.ancho + 'px';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'th-label';
        const labelSpan = document.createElement('span');
        labelSpan.textContent = col.label;
        labelDiv.appendChild(labelSpan);
        th.appendChild(labelDiv);

        // input filtro
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'filtrar...';
        input.style.width = '100%';
        input.style.marginTop = '3px';
        input.style.borderRadius = '999px';
        input.style.border = '1px solid var(--gris-borde)';
        input.style.padding = '2px 8px';
        input.style.fontSize = '11px';
        input.dataset.key = col.key;

        input.value = filtros[col.key] || '';

        input.addEventListener('input', (e) => {
          filtros[col.key] = e.target.value.toLowerCase();
          renderTabla();
        });

        th.appendChild(input);
        return th;
      }

      columnasBase.forEach(c => {
        theadRow.appendChild(creaTH(c));
      });

      // columnas de reuni√≥n (despu√©s de fecha de termino)
      data.columnasReunion.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.titulo || col.id;
        th.style.minWidth = '160px';
        theadRow.appendChild(th);
      });
    }

    /********** UI: RENDER FILAS **********/
    function pasaFiltros(fila) {
      // filtros de texto
      const tTema = (fila.tema || '').toLowerCase();
      const tSub = (fila.subTema || '').toLowerCase();
      const tResp = (fila.responsable || '').toLowerCase();
      const tEst = (fila.estado || '').toLowerCase();
      const fech = isoToDDMMYY(fila.fechaTermino || '').toLowerCase();

      if (filtros.tema && !tTema.includes(filtros.tema)) return false;
      if (filtros.subTema && !tSub.includes(filtros.subTema)) return false;
      if (filtros.responsable && !tResp.includes(filtros.responsable)) return false;
      if (filtros.estado && !tEst.includes(filtros.estado)) return false;
      if (filtros.fechaTermino && !fech.includes(filtros.fechaTermino)) return false;

      return true;
    }

    function columnasReunionVisibles() {
      if (filtroFechaModo === 'todas') return data.columnasReunion;

      if (filtroFechaModo === 'ultimas2') {
        return data.columnasReunion.slice(-2);
      }

      if (filtroFechaModo === 'hoy') {
        const hoy = hoyISO();
        return data.columnasReunion.filter(c => c.tituloISO === hoy);
      }

      return data.columnasReunion;
    }

    function renderTabla() {
      construirEncabezado();

      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      const colsReuVisibles = columnasReunionVisibles();

      data.filas.forEach((fila, rowIndex) => {
        if (!pasaFiltros(fila)) return;

        const tr = document.createElement('tr');

        // tema
        let tdTema = document.createElement('td');
        const inpTema = document.createElement('textarea');
        inpTema.className = 'td-textarea';
        inpTema.value = fila.tema || '';
        inpTema.addEventListener('change', () => {
          fila.tema = inpTema.value;
          guardarEnStorage();
        });
        tdTema.appendChild(inpTema);
        tr.appendChild(tdTema);

        // sub tema
        let tdSub = document.createElement('td');
        const inpSub = document.createElement('textarea');
        inpSub.className = 'td-textarea';
        inpSub.value = fila.subTema || '';
        // doble clic para abrir link si s√≥lo hay URL
        inpSub.addEventListener('dblclick', () => {
          const v = inpSub.value.trim();
          if (v.startsWith('http://') || v.startsWith('https://')) {
            window.open(v, '_blank');
          }
        });
        inpSub.addEventListener('change', () => {
          fila.subTema = inpSub.value;
          guardarEnStorage();
        });
        tdSub.appendChild(inpSub);
        tr.appendChild(tdSub);

        // responsable
        let tdResp = document.createElement('td');
        const selResp = document.createElement('select');
        selResp.className = 'select-responsable';

        // opci√≥n vac√≠a
        const optEmpty = document.createElement('option');
        optEmpty.value = '';
        optEmpty.textContent = '';
        selResp.appendChild(optEmpty);

        responsables.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.textContent = r;
          selResp.appendChild(opt);
        });
        selResp.value = fila.responsable || '';

        selResp.addEventListener('change', () => {
          fila.responsable = selResp.value;
          guardarEnStorage();
        });

        tdResp.appendChild(selResp);
        tr.appendChild(tdResp);

        // estado (badge + select)
        let tdEst = document.createElement('td');
        const wrapEst = document.createElement('div');
        wrapEst.style.display = 'flex';
        wrapEst.style.alignItems = 'center';
        wrapEst.style.gap = '6px';

        const badge = document.createElement('span');
        badge.className = 'badge-estado';
        setBadgeEstado(badge, fila.estado || 'P');

        const selEst = document.createElement('select');
        selEst.className = 'select-estado';
        ESTADOS.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e;
          opt.textContent = e;
          selEst.appendChild(opt);
        });
        selEst.value = fila.estado || 'P';

        selEst.addEventListener('change', () => {
          fila.estado = selEst.value;
          setBadgeEstado(badge, selEst.value);
          guardarEnStorage();
        });

        wrapEst.appendChild(badge);
        wrapEst.appendChild(selEst);
        tdEst.appendChild(wrapEst);
        tr.appendChild(tdEst);

        // fecha de termino (input date al enfoque)
        let tdFecha = document.createElement('td');
        tdFecha.className = 'td-fecha';

        const inpFecha = document.createElement('input');
        inpFecha.type = 'text';
        inpFecha.className = 'td-input';
        inpFecha.readOnly = true;
        inpFecha.value = isoToDDMMYY(fila.fechaTermino || '');

        inpFecha.addEventListener('click', () => {
          // crear input date temporal
          const tmp = document.createElement('input');
          tmp.type = 'date';
          tmp.style.position = 'absolute';
          const rect = inpFecha.getBoundingClientRect();
          tmp.style.left = rect.left + 'px';
          tmp.style.top = rect.top + 'px';
          tmp.style.zIndex = '40';
          tmp.value = fila.fechaTermino || hoyISO();
          document.body.appendChild(tmp);
          tmp.focus();

          tmp.addEventListener('change', () => {
            fila.fechaTermino = tmp.value;
            inpFecha.value = isoToDDMMYY(tmp.value);
            guardarEnStorage();
          });

          const cleanup = () => {
            document.body.removeChild(tmp);
          };
          tmp.addEventListener('blur', cleanup, { once: true });
        });

        tdFecha.appendChild(inpFecha);
        tr.appendChild(tdFecha);

        // columnas de reuni√≥n visibles
        colsReuVisibles.forEach(col => {
          const td = document.createElement('td');
          const ta = document.createElement('textarea');
          ta.className = 'td-textarea';
          ta.value = (fila.reuniones && fila.reuniones[col.id]) || '';
          ta.addEventListener('change', () => {
            if (!fila.reuniones) fila.reuniones = {};
            fila.reuniones[col.id] = ta.value;
            guardarEnStorage();
          });
          td.appendChild(ta);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function setBadgeEstado(el, estado) {
      el.textContent = estado;
      el.className = 'badge-estado';
      if (estado === 'P') el.classList.add('estado-P');
      if (estado === 'EP') el.classList.add('estado-EP');
      if (estado === 'T') el.classList.add('estado-T');
    }

    /********** ACCIONES **********/
    document.getElementById('btnAddRow').addEventListener('click', () => {
      data.filas.push({
        tema: '',
        subTema: '',
        responsable: '',
        estado: 'P',
        fechaTermino: '',
        reuniones: {}
      });
      guardarEnStorage();
      renderTabla();
    });

    document.getElementById('btnAddColumn').addEventListener('click', () => {
      const iso = hoyISO();
      const titulo = prompt('T√≠tulo de la nueva columna de reuni√≥n (ej. fecha de la junta):', iso);
      if (!titulo) return;
      const id = 'col_' + Date.now();
      data.columnasReunion.push({ id, titulo, tituloISO: iso });
      guardarEnStorage();
      renderTabla();
    });

    // exportar / importar
    document.getElementById('btnExport').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify({ data, responsables }, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tablero_reuniones.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('JSON exportado', 'success');
    });

    document.getElementById('btnImport').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const obj = JSON.parse(ev.target.result);
            if (obj.data) data = obj.data;
            if (obj.responsables) responsables = obj.responsables;
            guardarEnStorage();
            renderTabla();
            showToast('JSON importado', 'success');
          } catch (err) {
            console.error(err);
            showToast('Error al importar', 'error');
          }
        };
        reader.readAsText(file);
      });
      input.click();
    });

    // scroll horizontal
    const scrollDiv = document.getElementById('tableScroll');
    document.getElementById('btnScrollLeft').addEventListener('click', () => {
      scrollDiv.scrollBy({ left: -250, behavior: 'smooth' });
    });
    document.getElementById('btnScrollRight').addEventListener('click', () => {
      scrollDiv.scrollBy({ left: 250, behavior: 'smooth' });
    });

    // filtros de columnas de reuni√≥n (Todas / √öltimas 2 / Hoy)
    const btnTodos = document.getElementById('btnFiltroTodos');
    const btnUltimas2 = document.getElementById('btnFiltroUltimas2');
    const btnHoy = document.getElementById('btnFiltroHoy');

    function actualizarChipFechaActiva() {
      [btnTodos, btnUltimas2, btnHoy].forEach(b => b.classList.remove('chip-toggle--active'));
      if (filtroFechaModo === 'todas') btnTodos.classList.add('chip-toggle--active');
      if (filtroFechaModo === 'ultimas2') btnUltimas2.classList.add('chip-toggle--active');
      if (filtroFechaModo === 'hoy') btnHoy.classList.add('chip-toggle--active');
    }

    btnTodos.addEventListener('click', () => {
      filtroFechaModo = 'todas';
      actualizarChipFechaActiva();
      renderTabla();
    });

    btnUltimas2.addEventListener('click', () => {
      filtroFechaModo = 'ultimas2';
      actualizarChipFechaActiva();
      renderTabla();
    });

    btnHoy.addEventListener('click', () => {
      filtroFechaModo = 'hoy';
      actualizarChipFechaActiva();
      renderTabla();
    });

    /********** MODAL DE AYUDA **********/
    const helpBackdrop = document.getElementById('helpBackdrop');
    document.getElementById('btnHelp').addEventListener('click', () => {
      helpBackdrop.style.display = 'flex';
    });
    document.getElementById('btnHelpClose').addEventListener('click', () => {
      helpBackdrop.style.display = 'none';
    });
    helpBackdrop.addEventListener('click', (e) => {
      if (e.target === helpBackdrop) helpBackdrop.style.display = 'none';
    });

    /********** INICIO **********/
    cargarDesdeStorage();
    actualizarChipFechaActiva();
    renderTabla();
  </script>
</body>

</html>
