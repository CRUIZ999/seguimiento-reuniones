<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento de tareas y reuniones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #e0ecff;
      --primary-soft-strong: #d1e3ff;
      --bg: #f4f5f7;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --border-dark: #cbd5e1;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
      --inprocess: #fbbf24;
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 18px 32px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 6px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .user-tag {
      font-size: 11px;
      color: var(--text-muted);
    }

    .top-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .btn-chip {
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: white;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
      transition: transform 0.05s, box-shadow 0.15s, background 0.15s;
    }

    .btn-chip-secondary {
      background: #f3f4f6;
      color: #111827;
      box-shadow: none;
      border: 1px solid #e5e7eb;
    }

    .btn-chip:hover {
      transform: translateY(-1px);
      background: #1d4ed8;
    }

    .btn-chip-secondary:hover {
      background: #e5e7eb;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--border-dark);
      background: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }

    .btn-icon:hover {
      background: #f3f4ff;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.35);
      transform: translateY(-1px);
    }

    .btn-outline-danger {
      border: 1px solid #fecaca;
      color: #b91c1c;
      background: #fef2f2;
    }

    .pill-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid transparent;
    }

    .pill-p {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .pill-ep {
      background: #fef9c3;
      color: #92400e;
      border-color: #fef08a;
    }

    .pill-t {
      background: #dcfce7;
      color: #166534;
      border-color: #bbf7d0;
    }

    .card-table {
      margin-top: 10px;
      background: var(--card-bg);
      border-radius: 18px;
      padding: 12px 14px 10px;
      box-shadow:
        0 20px 40px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(148, 163, 184, 0.25);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead th {
      font-size: 12px;
      font-weight: 600;
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
      color: #4b5563;
    }

    tbody td {
      padding: 6px 8px;
      font-size: 13px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .cell-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 4px 7px;
      font-size: 13px;
      background: transparent;
      outline: none;
    }

    .cell-input:hover {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .cell-input:focus {
      background: #eef2ff;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.35);
    }

    .estado-select {
      width: 80px;
      border-radius: 999px;
      padding: 3px 7px;
      border: 1px solid transparent;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      outline: none;
      background: #f1f5f9;
      color: #111827;
    }

    .estado-p {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .estado-ep {
      background: #fef9c3;
      color: #92400e;
      border-color: #fef08a;
    }

    .estado-t {
      background: #dcfce7;
      color: #166534;
      border-color: #bbf7d0;
    }

    .footer-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .footer-note input[type="checkbox"] {
      transform: scale(0.9);
    }

    /* Filtros en encabezados */
    .header-filter-input {
      width: 95%;
      margin-top: 4px;
      padding: 2px 4px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #dde3f0;
      outline: none;
      background: #f9fafb;
    }

    .header-filter-select {
      width: 95%;
      margin-top: 4px;
      padding: 2px 4px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #dde3f0;
      outline: none;
      background: #f9fafb;
    }

    .header-filter-input:focus,
    .header-filter-select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      background: white;
    }

    .header-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      margin-top: 2px;
      color: #6b7280;
    }

    /* Filtros de columnas de reuniones */
    .meeting-filters {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .meeting-btn {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 4px 10px;
      font-size: 11px;
      background: #f9fafb;
      cursor: pointer;
      color: #374151;
    }

    .meeting-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    /* Columna fecha de término */
    .fecha-cell {
      max-width: 40ch;
      word-wrap: break-word;
      white-space: normal;
    }

    /* Ocultar columnas dinámicamente */
    .col-hidden {
      display: none;
    }

    @media (max-width: 900px) {
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-buttons {
        justify-content: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="header-row">
      <div class="title-block">
        <h1>Seguimiento de tareas y reuniones</h1>
        <div class="subtitle">
          Columnas base: <strong>tema</strong>, <strong>sub tema</strong>,
          <strong>responsable</strong>, <strong>estado</strong>,
          <strong>fecha de término</strong>. Cada nueva reunión agrega una columna
          con la fecha del día como título.
          <br />
          En <strong>estado</strong> usa: P (Pendiente), EP (En proceso), T
          (Terminado).
        </div>
        <div class="user-tag" id="usuarioLabel"></div>
      </div>

      <div class="top-buttons">
        <button id="btnAddRow" class="btn-chip">
          + Fila
        </button>

        <button id="btnAddColumn" class="btn-chip btn-chip-secondary">
          + Columna
        </button>

        <button id="btnResponsables" class="btn-chip btn-chip-secondary">
          Responsables
        </button>

        <!-- Solo iconos para exportar / importar -->
        <button id="btnExport" class="btn-icon" title="Exportar JSON">
          ⬇
        </button>
        <button id="btnImport" class="btn-icon" title="Importar JSON">
          ⬆
        </button>

        <button id="btnLogout" class="btn-chip btn-outline-danger">
          Cerrar sesión
        </button>
      </div>
    </div>

    <div style="margin-top: 8px; display: flex; justify-content: flex-end;">
      <div class="meeting-filters">
        <button id="btnShowAllColumns" class="meeting-btn active">
          Todas
        </button>
        <button id="btnLastTwoColumns" class="meeting-btn">
          Últimas 2 fechas
        </button>
        <button id="btnTodayColumns" class="meeting-btn">
          Solo hoy
        </button>
      </div>
    </div>

    <div class="card-table">
      <table id="tasksTable">
        <thead>
          <tr id="headerRow">
            <th>
              tema
              <input
                id="filterTema"
                class="header-filter-input"
                type="text"
                placeholder="filtrar…"
              />
            </th>
            <th>
              sub tema
              <input
                id="filterSubtema"
                class="header-filter-input"
                type="text"
                placeholder="filtrar…"
              />
            </th>
            <th>
              responsable
              <select id="filterResponsable" class="header-filter-select">
                <option value="Todos">Todos</option>
              </select>
            </th>
            <th>
              estado
              <select id="filterEstado" class="header-filter-select">
                <option value="Todos">Todos</option>
                <option value="P">P</option>
                <option value="EP">EP</option>
                <option value="T">T</option>
              </select>
              <label class="header-checkbox">
                <input type="checkbox" id="filterOcultarTerminados" />
                Ocultar T
              </label>
            </th>
            <th>
              fecha de termino
            </th>
            <!-- aquí se insertan las columnas de reuniones dinámicamente -->
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- filas dinámicas -->
        </tbody>
      </table>
    </div>

    <label class="footer-note">
      <input type="checkbox" checked disabled />
      Los datos (incluyendo comentarios y lista de responsables) se guardan en
      este navegador, por usuario.
    </label>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://hrbmstaklleraiacqmky.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyYm1zdGFrbGxlcmFpYWNxbWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTA2OTQsImV4cCI6MjA3ODc4NjY5NH0.tN00tAjMJpJK_8gnerocbOSzHp93N5yc9KohTBpMeZc";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
      },
    });

    // ---- Estado en memoria ----
    let currentUserEmail = null;
    let storageKey = null;

    let rows = []; // { id, tema, subtema, responsable, estado, fecha, reuniones: { [colId]: texto } }
    let responsables = ["Carlos Ruiz"];
    let meetingColumns = []; // [{id, title, dateISO}]

    const filtros = {
      tema: "",
      subtema: "",
      estado: "Todos",
      responsable: "Todos",
      ocultarTerminados: false,
    };

    // ---- Utilidades de almacenamiento ----
    function saveToStorage() {
      if (!storageKey) return;
      const payload = { rows, responsables, meetingColumns };
      localStorage.setItem(storageKey, JSON.stringify(payload));
    }

    function loadFromStorage() {
      if (!storageKey) return;
      const raw = localStorage.getItem(storageKey);
      if (!raw) {
        // Primera vez: una fila de ejemplo
        rows = [
          {
            id: crypto.randomUUID(),
            tema: "",
            subtema: "",
            responsable: "",
            estado: "P",
            fecha: "",
            reuniones: {},
          },
        ];
        responsables = ["Carlos Ruiz"];
        meetingColumns = [];
        return;
      }

      try {
        const data = JSON.parse(raw);
        rows = data.rows || [];
        responsables = data.responsables || [];
        meetingColumns = data.meetingColumns || [];
      } catch (e) {
        console.error("Error al leer storage", e);
      }
    }

    // ---- Filtros de encabezado ----
    function initHeaderFilters() {
      const inputTema = document.getElementById("filterTema");
      const inputSub = document.getElementById("filterSubtema");
      const selEstado = document.getElementById("filterEstado");
      const selResp = document.getElementById("filterResponsable");
      const chkOcultarT = document.getElementById("filterOcultarTerminados");

      inputTema.addEventListener("input", () => {
        filtros.tema = inputTema.value.trim().toLowerCase();
        renderTablaFiltrada();
      });

      inputSub.addEventListener("input", () => {
        filtros.subtema = inputSub.value.trim().toLowerCase();
        renderTablaFiltrada();
      });

      selEstado.addEventListener("change", () => {
        filtros.estado = selEstado.value;
        renderTablaFiltrada();
      });

      selResp.addEventListener("change", () => {
        filtros.responsable = selResp.value;
        renderTablaFiltrada();
      });

      chkOcultarT.addEventListener("change", () => {
        filtros.ocultarTerminados = chkOcultarT.checked;
        renderTablaFiltrada();
      });
    }

    function actualizarFiltroResponsables() {
      const selResp = document.getElementById("filterResponsable");
      if (!selResp) return;
      const valorActual = selResp.value || "Todos";
      selResp.innerHTML = '<option value="Todos">Todos</option>';
      responsables.forEach((r) => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        selResp.appendChild(opt);
      });
      if ([...selResp.options].some((o) => o.value === valorActual)) {
        selResp.value = valorActual;
      } else {
        selResp.value = "Todos";
      }
    }

    function aplicarFiltros() {
      return rows.filter((row) => {
        if (filtros.tema) {
          const texto = (row.tema || "").toString().toLowerCase();
          if (!texto.includes(filtros.tema)) return false;
        }

        if (filtros.subtema) {
          const texto = (row.subtema || "").toString().toLowerCase();
          if (!texto.includes(filtros.subtema)) return false;
        }

        if (filtros.estado !== "Todos" && row.estado !== filtros.estado) {
          return false;
        }

        if (
          filtros.responsable !== "Todos" &&
          row.responsable !== filtros.responsable
        ) {
          return false;
        }

        if (filtros.ocultarTerminados && row.estado === "T") {
          return false;
        }

        return true;
      });
    }

    // ---- Renderizado tabla ----
    function renderTablaFiltrada() {
      const datos = aplicarFiltros();
      renderTable(datos);
    }

    function renderTable(data) {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      // Actualizar encabezado de columnas de reuniones
      const headerRow = document.getElementById("headerRow");
      // Limpia todas las th dinámicas previas
      while (headerRow.children.length > 5) {
        headerRow.removeChild(headerRow.lastChild);
      }

      meetingColumns.forEach((col) => {
        const th = document.createElement("th");
        th.textContent = col.title;
        th.dataset.meetingId = col.id;
        headerRow.appendChild(th);
      });

      data.forEach((row) => {
        const tr = document.createElement("tr");

        // tema
        const tdTema = document.createElement("td");
        const inputTema = document.createElement("input");
        inputTema.className = "cell-input";
        inputTema.value = row.tema || "";
        inputTema.addEventListener("input", () => {
          row.tema = inputTema.value;
          saveToStorage();
        });
        tdTema.appendChild(inputTema);
        tr.appendChild(tdTema);

        // sub tema
        const tdSub = document.createElement("td");
        const inputSub = document.createElement("input");
        inputSub.className = "cell-input";
        inputSub.value = row.subtema || "";
        inputSub.addEventListener("input", () => {
          row.subtema = inputSub.value;
          saveToStorage();
        });
        tdSub.appendChild(inputSub);
        tr.appendChild(tdSub);

        // responsable
        const tdResp = document.createElement("td");
        const selResp = document.createElement("select");
        selResp.className = "cell-input";
        const optEmpty = document.createElement("option");
        optEmpty.value = "";
        optEmpty.textContent = "";
        selResp.appendChild(optEmpty);
        responsables.forEach((r) => {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          selResp.appendChild(opt);
        });
        selResp.value = row.responsable || "";
        selResp.addEventListener("change", () => {
          row.responsable = selResp.value;
          saveToStorage();
        });
        tdResp.appendChild(selResp);
        tr.appendChild(tdResp);

        // estado (solo un select con color)
        const tdEstado = document.createElement("td");
        const selEstado = document.createElement("select");
        selEstado.className = "estado-select";
        ["P", "EP", "T"].forEach((code) => {
          const opt = document.createElement("option");
          opt.value = code;
          opt.textContent = code;
          selEstado.appendChild(opt);
        });
        selEstado.value = row.estado || "P";

        function updateEstadoClass() {
          selEstado.classList.remove("estado-p", "estado-ep", "estado-t");
          if (selEstado.value === "P") selEstado.classList.add("estado-p");
          if (selEstado.value === "EP") selEstado.classList.add("estado-ep");
          if (selEstado.value === "T") selEstado.classList.add("estado-t");
        }
        updateEstadoClass();

        selEstado.addEventListener("change", () => {
          row.estado = selEstado.value;
          updateEstadoClass();
          saveToStorage();
          renderTablaFiltrada(); // para que se aplique "Ocultar T"
        });

        tdEstado.appendChild(selEstado);
        tr.appendChild(tdEstado);

        // fecha de termino
        const tdFecha = document.createElement("td");
        tdFecha.className = "fecha-cell";
        const inputFecha = document.createElement("input");
        inputFecha.className = "cell-input";
        inputFecha.value = row.fecha || "";
        inputFecha.addEventListener("input", () => {
          row.fecha = inputFecha.value;
          saveToStorage();
        });
        tdFecha.appendChild(inputFecha);
        tr.appendChild(tdFecha);

        // columnas de reuniones
        meetingColumns.forEach((col) => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          input.className = "cell-input";
          const value =
            (row.reuniones && row.reuniones[col.id]) ? row.reuniones[col.id] : "";
          input.value = value;
          input.addEventListener("input", () => {
            if (!row.reuniones) row.reuniones = {};
            row.reuniones[col.id] = input.value;
            saveToStorage();
          });
          td.appendChild(input);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      aplicarFiltroColumnasReuniones();
    }

    // ---- Filtros de columnas de reuniones ----
    let modoColumnas = "todas"; // "todas" | "ultimas2" | "soloHoy"

    function aplicarFiltroColumnasReuniones() {
      const table = document.getElementById("tasksTable");
      const headerRow = document.getElementById("headerRow");

      const hoyISO = new Date().toISOString().slice(0, 10);

      // indices de columnas base: 0..4, las reuniones empiezan en 5
      meetingColumns.forEach((col, index) => {
        const thIndex = 5 + index;

        let hide = false;
        if (modoColumnas === "ultimas2") {
          const start = Math.max(meetingColumns.length - 2, 0);
          if (index < start) hide = true;
        } else if (modoColumnas === "soloHoy") {
          if (col.dateISO !== hoyISO) hide = true;
        }

        // th
        const th = headerRow.children[thIndex];
        if (th) th.classList.toggle("col-hidden", hide);

        // tds
        [...table.tBodies[0].rows].forEach((tr) => {
          const td = tr.children[thIndex];
          if (td) td.classList.toggle("col-hidden", hide);
        });
      });

      // botones activos
      document
        .getElementById("btnShowAllColumns")
        .classList.toggle("active", modoColumnas === "todas");
      document
        .getElementById("btnLastTwoColumns")
        .classList.toggle("active", modoColumnas === "ultimas2");
      document
        .getElementById("btnTodayColumns")
        .classList.toggle("active", modoColumnas === "soloHoy");
    }

    // ---- Botones de columnas ----
    function initMeetingButtons() {
      document.getElementById("btnShowAllColumns").addEventListener("click", () => {
        modoColumnas = "todas";
        aplicarFiltroColumnasReuniones();
      });
      document.getElementById("btnLastTwoColumns").addEventListener("click", () => {
        modoColumnas = "ultimas2";
        aplicarFiltroColumnasReuniones();
      });
      document.getElementById("btnTodayColumns").addEventListener("click", () => {
        modoColumnas = "soloHoy";
        aplicarFiltroColumnasReuniones();
      });
    }

    // ---- Acciones principales ----
    function addRow() {
      const newRow = {
        id: crypto.randomUUID(),
        tema: "",
        subtema: "",
        responsable: "",
        estado: "P",
        fecha: "",
        reuniones: {},
      };
      rows.push(newRow);
      saveToStorage();
      renderTablaFiltrada();
    }

    function addColumn() {
      const hoy = new Date();
      const dateISO = hoy.toISOString().slice(0, 10);
      const title = hoy.toLocaleDateString("es-MX");
      const col = {
        id: crypto.randomUUID(),
        title,
        dateISO,
      };
      meetingColumns.push(col);
      saveToStorage();
      renderTablaFiltrada();
    }

    function gestionarResponsables() {
      const actual = responsables.join(", ");
      const texto = prompt(
        "Lista de responsables (separados por coma):",
        actual
      );
      if (texto === null) return;
      const lista = texto
        .split(",")
        .map((t) => t.trim())
        .filter((t) => t.length > 0);
      responsables = [...new Set(lista)];
      saveToStorage();
      actualizarFiltroResponsables();
      renderTablaFiltrada();
    }

    function exportJSON() {
      const payload = { rows, responsables, meetingColumns };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "seguimiento_reuniones.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.addEventListener("change", () => {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            rows = data.rows || [];
            responsables = data.responsables || [];
            meetingColumns = data.meetingColumns || [];
            saveToStorage();
            actualizarFiltroResponsables();
            renderTablaFiltrada();
          } catch (e) {
            alert("Archivo JSON inválido");
          }
        };
        reader.readAsText(file);
      });
      input.click();
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    // ---- Inicio ----
    async function init() {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session || !data.session.user) {
        alert("No hay sesión activa, vuelve a iniciar desde el login.");
        window.location.href = "index.html";
        return;
      }

      currentUserEmail = data.session.user.email;
      storageKey = "seguimiento_" + currentUserEmail;
      document.getElementById("usuarioLabel").textContent =
        "Usuario: " + currentUserEmail;

      loadFromStorage();
      initHeaderFilters();
      initMeetingButtons();
      actualizarFiltroResponsables();

      // Botones
      document.getElementById("btnAddRow").addEventListener("click", addRow);
      document
        .getElementById("btnAddColumn")
        .addEventListener("click", addColumn);
      document
        .getElementById("btnResponsables")
        .addEventListener("click", gestionarResponsables);
      document.getElementById("btnExport").addEventListener("click", exportJSON);
      document.getElementById("btnImport").addEventListener("click", importJSON);
      document.getElementById("btnLogout").addEventListener("click", logout);

      renderTablaFiltrada();
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
